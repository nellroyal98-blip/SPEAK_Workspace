<!DOCTYPE html>
<!--
  Fully annotated version of the jsPsych task file.
  The goal of these comments is to help developers understand every step of the
  structure, data flow, timing, and user interaction logic.
  All annotations are in English and describe both the high‑level design and
  low‑level behaviour.
-->
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Woche 10 – G5 jsPsych</title>

  <!-- Load jsPsych core library (v6.3.1). Provides timeline engine, trial types, data handling. -->
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <!-- Default jsPsych CSS for layout and typography. -->
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet" />
  
  <!-- Plugin: html-button-response
       Enables displaying custom HTML and waiting for button presses. -->
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>

  <!-- PapaParse for CSV loading (async file parsing). -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* General page layout (white background, standard font). */
    body{
      background:#fff;
      font-family:Arial, sans-serif;
      margin:0;
      padding:0;
    }
    .center{ text-align:center; }

    /* Generic next-button styling using an image. */
    .next-btn{
      background:none;
      border:none;
      cursor:pointer;
    }
    .next-btn img{ height:56px; }

    /* Speaker icon used to trigger audio playback. */
    .speaker-btn{
      background:none;
      border:none;
      cursor:pointer;
    }
    .speaker-btn img{ height:60px; }

    /* Row layout for the four sentence boxes (image1, image2, article, target image). */
    .sentence-row{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:20px auto 26px auto;
    }

    /* Square boxes that contain either images, text, or article words. */
    .sentence-box{
      width:150px;
      height:150px;
      border:4px solid #333;
      border-radius:16px;
      background:#f3f3f3;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.8em;
      position:relative;
      box-sizing:border-box;
    }

    /* Ensures images fit inside the sentence boxes. */
    .sentence-box img{
      max-width:100%;
      max-height:100%;
      border-radius:12px;
    }

    /* Grid container used in task trials to show clickable tiles with articles + images. */
    .grid{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:10px auto 30px auto;
      flex-wrap:wrap;
      max-width:950px;
    }

    /* Individual clickable tile. Contains one image and its article text. */
    .tile{
      border-radius:16px;
      border:4px solid #333;
      padding:6px 6px 8px 6px;
      background:#f8f8f8;
      cursor:pointer;
      width:120px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:border .15s, background .15s, transform .1s;
    }

    .tile img{
      width:100%;
      height:auto;
      border-radius:10px;
      display:block;
    }

    /* Hover effect when user moves cursor over tile. */
    .tile:hover{
      border-color:#8bc34a;
      background:#eef8e4;
      transform:translateY(-1px);
    }

    /* Hide tile after it is selected once (article already used). */
    .tile.hidden{ display:none; }

    /* Article text under tile image, colored by grammatical article. */
    .article-text{
      margin-top:4px;
      font-size:1.2em;
      font-weight:bold;
    }
    .a-die{ color:#e53935; }
    .a-das{ color:#2e7d32; }
    .a-der{ color:#1e88e5; }

    /* Highlight frame for audio playback, emphasizes currently spoken element. */
    .highlight{
      box-shadow:0 0 0 6px rgba(255,152,0,0.85);
    }

    /* Fullscreen stars animation shown after each correct article selection. */
    #stars-overlay{
      position:fixed;
      left:0;
      top:0;
      width:100%;
      height:100%;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      pointer-events:none; /* Prevents user interaction during animation. */
    }
    #stars-overlay img{ width:260px; }
  </style>
</head>
<body>

<!-- jsPsych content container -->
<div id="jspsych-target"></div>

<!-- Stars animation overlay. Appears briefly after each successful tile selection. -->
<div id="stars-overlay">
  <img src="stimuli_AD/stars.png" alt="Stars">
</div>

<script>
  /* Base directory for all audio and image files. */
  const STIM = "stimuli_AD/";

  /*
    Utility: Load a CSV file using PapaParse and return a Promise resolving to
    an array of row objects. Each row is represented as a JS object keyed by
    column names.
  */
  function loadCSV(url){
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        header:true,          // First row contains column names.
        download:true,        // Load via XHR.
        skipEmptyLines:true,  // Ignore blank rows.
        complete: r => resolve(r.data || []),
        error: e => reject(e)
      });
    });
  }

  /*
    Utility: Play audio file via HTMLAudioElement.
    Returns a Promise that resolves automatically after the audio finishes or
    fails to load. Used for timed chaining of audio, highlights, and stars.
  */
  function playAudio(src){
    return new Promise(res => {
      if(!src){ res(); return; }
      const a = new Audio(src);
      a.onended = () => res();
      a.onerror = () => res();
      a.play().catch(()=>res());
    });
  }

  /* Map article words to CSS classes defining text color. */
  function articleClass(txt){
    if(!txt) return "";
    const t = txt.trim().toLowerCase();
    if(t === "die") return "a-die";
    if(t === "das") return "a-das";
    if(t === "der" || t === "den") return "a-der";
    return "";
  }

  /*
    Display stars animation and play success audio. Used after every correct
    article assignment. The overlay is shown briefly then hidden.
  */
  async function starsSuccess(){
    const overlay = document.getElementById("stars-overlay");
    overlay.style.display = "flex";
    await playAudio(STIM + "stars_correct.mp3");
    await new Promise(r => setTimeout(r, 600));
    overlay.style.display = "none";
  }

  /* Plays flip sound when transitioning between screens. */
  async function flipSentence(){
    await playAudio(STIM + "flip_sound.wav");
  }

  /*
    MAIN LOGIC: Immediately invoked async function.
    Loads CSV files, builds jsPsych timeline, runs study.
  */
  (async function main(){

    /* Load CSV files containing general settings, example trials, and task trials. */
    let generalRows, exampleRows, taskRows;
    try{
      generalRows = await loadCSV("data/K2_W10_G5_general.csv");
      exampleRows = await loadCSV("data/K2_W10_G5_example.csv");
      taskRows    = await loadCSV("data/K2_W10_G5_task.csv");
    }catch(e){
      alert("CSV error: " + e);
      return;
    }

    /* General configuration comes from first row of general CSV. */
    const general = (generalRows && generalRows.length) ? generalRows[0] : {};

    /* jsPsych timeline contains all ordered trial objects. */
    const timeline = [];

    /*
      ================================
      WELCOME SCREEN
      ================================
      Contains speaker icon to play explanation audio and next-button.
    */
    timeline.push({
      type:"html-button-response",
      choices:[],   // No default buttons; navigation via custom HTML elements.
      stimulus:`
        <div class="center" style="margin-top:40px;">
          <h2>Woche 10 – Aufgabe G5</h2>
          <p>Hör dir die Erklärung an. Klicke danach auf den Pfeil, um zu starten.</p>

          <div style="margin-top:10px;">
            <button class="speaker-btn" id="welcome-speaker">
              <img src="stimuli_AD/speaker.png" alt="Erklärung anhören">
            </button>
          </div>

          <div style="margin-top:22px;">
            <img
              src="stimuli_AD/Week10_G5.png"
              alt="Beispiel"
              style="max-width:60%; border-radius:12px; border:6px solid #bbbbbb;"
            >
          </div>

          <div style="margin-top:22px;">
            <button class="next-btn" id="welcome-next">
              <img src="stimuli_AD/next.png" alt="Weiter">
            </button>
          </div>
        </div>
      `,
      on_load: function(){
        /* Play explanation audio when speaker icon clicked. */
        const sp = document.getElementById("welcome-speaker");
        const btn = document.getElementById("welcome-next");

        if(sp && general.explanation_audio){
          sp.onclick = () => {
            playAudio(STIM + general.explanation_audio);
          };
        }

        /* Continue to next screen when next-icon clicked. */
        if(btn){
          btn.onclick = async () => {
            await flipSentence();
            jsPsych.finishTrial();
          };
        }
      }
    });

    /*
      ================================
      EXAMPLE TRIALS
      ================================
      Each example shows two images, then on play:
        - image1 audio
        - image2 audio
        - article + target image
        - highlight animations
        - success stars
    */
    exampleRows.forEach((row, idx) => {
      timeline.push({
        type:"html-button-response",
        choices:[],
        stimulus: function(){
          /* Insert images dynamically based on CSV columns. */
          const img1 = row.image1 ? STIM + row.image1 : "";
          const img2 = row.image2 ? STIM + row.image2 : "";
          const img3 = row.image3 ? STIM + row.image3 : "";
          const article = row.article || "";

          return `
            <div class="center" style="margin-top:10px;">
              <h3>Beispiel ${idx+1}</h3>
              <div class="sentence-row">
                <div class="sentence-box" id="ex-b1">
                  ${img1 ? `<img src="${img1}">` : ""}
                </div>
                <div class="sentence-box" id="ex-b2">
                  ${img2 ? `<img src="${img2}">` : ""}
                </div>
                <div class="sentence-box" id="ex-b3"></div>
                <div class="sentence-box" id="ex-b4"></div>
              </div>

              <!-- Button to play the guided example sequence -->
              <button class="speaker-btn" id="ex-play">
                <img src="stimuli_AD/speaker.png" alt="Play">
              </button>

              <div class="center" style="margin-top:10px;">
                <button class="next-btn" id="ex-next" style="display:none;">
                  <img src="stimuli_AD/next.png" alt="Weiter">
                </button>
              </div>
            </div>
          `;
        },
        on_load: function(){
          const b1 = document.getElementById("ex-b1");
          const b2 = document.getElementById("ex-b2");
          const b3 = document.getElementById("ex-b3");
          const b4 = document.getElementById("ex-b4");
          const playBtn = document.getElementById("ex-play");
          const nextBtn = document.getElementById("ex-next");

          /* Preload audio references. */
          const a1 = row.image1_audio ? STIM + row.image1_audio : "";
          const a2 = row.image2_audio ? STIM + row.image2_audio : "";
          const a3 = row.image3_audio ? STIM + row.image3_audio : "";
          const article = row.article || "";
          const img3 = row.image3 ? STIM + row.image3 : "";

          let playing = false;

          /* Allow clicking boxes individually for audio preview. */
          if(b1 && a1){
            b1.onclick = async () => {
              if(playing) return;
              playing = true;
              b1.classList.add("highlight");
              await playAudio(a1);
              b1.classList.remove("highlight");
              playing = false;
            };
          }
          if(b2 && a2){
            b2.onclick = async () => {
              if(playing) return;
              playing = true;
              b2.classList.add("highlight");
              await playAudio(a2);
              b2.classList.remove("highlight");
              playing = false;
            };
          }

          /* Guided complete example sequence. */
          if(playBtn){
            playBtn.onclick = async () => {
              if(playing) return;
              playing = true;

              /* image1 */
              if(b1 && a1){
                b1.classList.add("highlight");
                await playAudio(a1);
                b1.classList.remove("highlight");
              }

              /* image2 */
              if(b2 && a2){
                b2.classList.add("highlight");
                await playAudio(a2);
                b2.classList.remove("highlight");
              }

              /* Display article + target image */
              if(b3){
                b3.textContent = article;
                b3.classList.add(articleClass(article));
              }
              if(b4 && img3){
                b4.innerHTML = `<img src="${img3}">`;
              }

              /* Audio for article segment */
              if(b3) b3.classList.add("highlight");
              if(b4) b4.classList.add("highlight");
              if(a3){ await playAudio(a3); }
              if(b3) b3.classList.remove("highlight");
              if(b4) b4.classList.remove("highlight");

              await starsSuccess();

              if(nextBtn) nextBtn.style.display = "inline-block";
              playing = false;
            };
          }

          /* Next example trial */
          if(nextBtn){
            nextBtn.onclick = async () => {
              await flipSentence();
              jsPsych.finishTrial();
            };
          }
        }
      });
    });

    /*
      ================================
      TASK TRIALS
      ================================
      User must choose correct articles matching images. Each correct
      selection triggers:
        - feedback audio (full sentence)
        - highlight
        - star animation
        - tile removal
        - progression until all tiles in a row are used.
    */
    taskRows.forEach((row, idx) => {
      timeline.push({
        type:"html-button-response",
        choices:[],
        data:{trial_index:idx},
        stimulus: function(){

          /* Provide first two images, leaving boxes 3 and 4 empty initially. */
          const img1 = row.image1 ? STIM + row.image1 : "";
          const img2 = row.image2 ? STIM + row.image2 : "";

          return `
            <div class="center" style="margin-top:10px;">
              <h3>Aufgabe ${idx+1}</h3>
              <div class="sentence-row">
                <div class="sentence-box" id="t-b1">
                  ${img1 ? `<img src="${img1}">` : ""}
                </div>
                <div class="sentence-box" id="t-b2">
                  ${img2 ? `<img src="${img2}">` : ""}
                </div>
                <div class="sentence-box" id="t-b3"></div>
                <div class="sentence-box" id="t-b4"></div>
              </div>

              <!-- Button repeats the question (article prompt + images). -->
              <button class="speaker-btn" id="t-play">
                <img src="stimuli_AD/speaker.png" alt="Play question">
              </button>

              <!-- Tile grid below for article selection -->
              <div class="grid" id="tiles"></div>
            </div>
          `;
        },
        on_load: function(){

          const box1 = document.getElementById("t-b1");
          const box2 = document.getElementById("t-b2");
          const box3 = document.getElementById("t-b3");
          const box4 = document.getElementById("t-b4");
          const playBtn = document.getElementById("t-play");
          const grid = document.getElementById("tiles");

          /* Audio references from CSV. */
          const questionAud = row.question ? STIM + row.question : "";
          const a1 = row.audio1 ? STIM + row.audio1 : "";
          const a2 = row.audio2 ? STIM + row.audio2 : "";

          /* Clicking image boxes plays standalone audio (preview). */
          if(box1 && a1){
            box1.onclick = async () => {
              box1.classList.add("highlight");
              await playAudio(a1);
              box1.classList.remove("highlight");
            };
          }
          if(box2 && a2){
            box2.onclick = async () => {
              box2.classList.add("highlight");
              await playAudio(a2);
              box2.classList.remove("highlight");
            };
          }

          /* Play full question sequence on speaker click. */
          if(playBtn){
            playBtn.onclick = async () => {
              if(questionAud){ await playAudio(questionAud); }
              if(box1 && a1){
                box1.classList.add("highlight");
                await playAudio(a1);
                box1.classList.remove("highlight");
              }
              if(box2 && a2){
                box2.classList.add("highlight");
                await playAudio(a2);
                box2.classList.remove("highlight");
              }
            };
          }

          /* Build tile array from columns image4..image9 + article/audio mapping. */
          const tileData = [];
          const usedArticles = {};      // Prevent reusing the same article twice.
          const clickLog = [];          // For saving participant choices.

          for(let i=4; i<=9; i++){
            const imgk = "image"+i;
            if(!row[imgk]) continue;  // Skip if no tile for this index.

            const img = STIM + row[imgk];
            const artk = "article"+i;          // Article printed above tile.
            const abk  = "article_below"+i;    // Alternative article column.
            const wk   = "whole_sentence_image"+i; // Optional combined audio.
            const aok  = "audio"+i;             // Fallback audio.

            /* Determine displayed article and audio file for sentence. */
            const artBelow = row[abk] || "";
            const art = row[artk] || artBelow;
            const sentence = row[wk]
              ? STIM + row[wk]
              : row[aok]
                ? STIM + row[aok]
                : "";

            /* Create DOM tile element */
            const tile = document.createElement("div");
            tile.className = "tile task-tile";
            tile.innerHTML = `
              <img src="${img}">
              <div class="article-text ${articleClass(art)}">${art}</div>
            `;

            /* Store all tile data internally for dynamic removal + audio. */
            const record = {
              el: tile,
              article: art,
              img: img,
              sentence: sentence
            };
            tileData.push(record);

            /* Tile click handler: shows article + image in sentence boxes. */
            tile.onclick = async () => {
              const chosenArticle = (art || "").trim();
              if(!chosenArticle) return;

              /* Prevent using the same article twice. */
              if(usedArticles[chosenArticle]) return;
              usedArticles[chosenArticle] = true;

              /* Display chosen article and image. */
              if(box3){
                box3.textContent = chosenArticle;
                box3.className = "sentence-box " + articleClass(chosenArticle);
              }
              if(box4){ box4.innerHTML = `<img src="${img}">`; }

              /* Play full sentence audio if present (article + noun). */
              if(sentence){
                if(box3) box3.classList.add("highlight");
                if(box4) box4.classList.add("highlight");
                await playAudio(sentence);
                if(box3) box3.classList.remove("highlight");
                if(box4) box4.classList.remove("highlight");
              }

              await starsSuccess();
              await flipSentence();

              /* Log click for data output. */
              clickLog.push({
                article: chosenArticle,
                image: img
              });

              /* Hide all tiles sharing this article. */
              tileData.forEach(td => {
                const a = (td.article || "").trim();
                if(a === chosenArticle){ td.el.classList.add("hidden"); }
              });

              /* Reset boxes 3 and 4 for next article selection. */
              if(box3){
                box3.textContent = "";
                box3.className = "sentence-box";
              }
              if(box4){
                box4.innerHTML = "";
                box4.className = "sentence-box";
              }

              /* If all tiles exhausted, finish trial. */
              const remaining = tileData.filter(td => !td.el.classList.contains("hidden"));
              if(remaining.length === 0){
                jsPsych.finishTrial({
                  trial_index: idx,
                  clicks: clickLog
                });
              }
            };

            /* Add tile to grid in DOM. */
            if(grid){ grid.appendChild(tile); }
          }

          /* If no tiles found (empty row), skip trial immediately. */
          if(tileData.length === 0){
            jsPsych.finishTrial({ trial_index: idx, clicks: [] });
          }
        }
      });
    });

    /*
      ================================
      GOODBYE SCREEN
      ================================
      Plays goodbye audio and shows finishing message.
    */
    timeline.push({
      type:"html-button-response",
      choices:[],
      stimulus:`
        <div class="center" style="margin-top:80px;">
          <h2>Geschafft!</h2>
          <p>Das hast du super gemacht!</p>

          <img
            src="stimuli_AD/i_002.jpg"
            alt="Endbild"
            style="max-width:300px; margin-top:20px; border-radius:12px;"
          >

          <div style="margin-top:22px;">
            <button class="next-btn" id="goodbye-next">
              <img src="stimuli_AD/next.png" alt="Weiter">
            </button>
          </div>
        </div>
      `,
      on_load: function(){
        /* Autoplay goodbye audio if defined in general CSV. */
        if(general.goodbye_audio){ playAudio(STIM + general.goodbye_audio); }

        const btn = document.getElementById("goodbye-next");
        if(btn){ btn.onclick = () => jsPsych.finishTrial(); }
      }
    });

    /* Initialize jsPsych. on_finish displays raw data table. */
    jsPsych.init({
      timeline: timeline,
      display_element: "jspsych-target",
      on_finish: () => { jsPsych.data.displayData(); }
    });

  })();
</script>
</body>
</html>
