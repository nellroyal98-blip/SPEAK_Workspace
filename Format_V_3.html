<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>SPEAK W12 G3</title>

<script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
<script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
<link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ABeeZee&display=swap" rel="stylesheet">

<style>
body{ background:#fff; margin:0; padding:0; }

.jspsych-display-element,
.jspsych-display-element *{
  font-family:"ABeeZee", sans-serif;
}

.wrap{
  width:980px;
  margin:0 auto;
  padding-top:20px;
}

.topLabel{
  position:absolute;
  right:30px;
  top:20px;
  font-size:22px;
}

.topRow{
  position:relative;
  height:auto;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  gap:12px;
}


.taskSpeaker{
  height:120px;
  cursor:pointer;
}


.tileRow{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:18px;
  margin-top:12px;
}

.tile{
  width:210px;
  height:170px;
  border-radius:26px;
  border:6px solid #2f3438;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  box-sizing:border-box;
}

.tile.grayBg{ background:#d8d8d8; }

.tile img.stim{
  max-width:190px;
  max-height:150px;
}

.articleTxt{
  font-size:92px;
  line-height:1;
  user-select:none;
}

.highlight{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:none;
  pointer-events:none;
}


.tile.clickable{ cursor:pointer; }

.tile.chosenBad{ outline:12px solid #e10000; outline-offset:6px; }

.navRow{
  display:flex;
  align-items:center;
  justify-content:center;
  margin-top:18px;
}

.navRow img{
  height:120px;
  cursor:pointer;
}

.navRow img.disabled{
  cursor:default;
}

.titleCard{
  width:760px;
  margin:0 auto;
  text-align:center;
}

.titleCard img.titleImg{
  width:760px;
  border-radius:18px;
}

.speakerRow{
  margin-top:14px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.speakerRow img{
  height:120px;
  cursor:pointer;
}
.titleImg.framed{
  border:6px solid #bbbbbb;
  border-radius:18px;
  box-sizing:border-box;
}

</style>
</head>

<body>
<div id="jspsych-target"></div>

<script>
const BASE = "/speakjspsych/";
const DATA = BASE + "data/";
const STIM = BASE + "stimuli_V_3/";

function loadCSV(url){
  return new Promise(resolve=>{
    Papa.parse(url,{
      header:true,
      download:true,
      complete:r=>{
        const rows = (r.data || []).filter(x=>x && Object.values(x).some(v=>String(v||"").trim()!==""));
        resolve(rows);
      }
    });
  });
}

function playAudio(file){
  return new Promise(resolve=>{
    if(!file || file==="None.mp3"){
      resolve();
      return;
    }
    const a = new Audio(STIM + file);
    a.play().catch(()=>resolve());
    a.onended = ()=>resolve();
  });
}

function showHL(id){
  const el = document.getElementById(id);
  if(el) el.style.display="block";
}
function hideHL(id){
  const el = document.getElementById(id);
  if(el) el.style.display="none";
}

function setNextEnabled(enabled){
  const nx = document.getElementById("nx");
  if(!nx) return;
  if(enabled){
    nx.src = STIM + "next.png";
    nx.classList.remove("disabled");
    nx.dataset.enabled="1";
  } else {
    nx.src = STIM + "next_empty.png";
    nx.classList.add("disabled");
    nx.dataset.enabled="0";
  }
}

(async function(){

const general  = (await loadCSV(DATA+"K2_W12_G3_general.csv"))[0] || {};
const examples = await loadCSV(DATA+"K2_W12_G3_example.csv");
const tasks    = await loadCSV(DATA+"K2_W12_G3_task.csv");

const title = {
  type:"html-button-response",
  choices:[],
  stimulus:`
    <div class="wrap">
      <div class="titleCard">
<div class="center" style="margin-top:40px;">
          <h2>Woche 12 – Aufgabe G3</h2>
  <p style="font-size:20px; margin-bottom:14px;">
    Hör dir die Erklärung an. Klicke danach auf den Pfeil, um zu starten.
  </p>

  <img class="titleImg framed" src="${STIM}Week12_G3.png">

  <div class="speakerRow">

          <img id="sp" src="${STIM}speaker.png">
          <img id="nx" class="disabled" src="${STIM}next_empty.png" data-enabled="0">
          <audio id="au" src="${STIM}${general.explanation_audio || ""}"></audio>
        </div>
      </div>
    </div>
  `,

  on_load(){
    const sp=document.getElementById("sp");
    const nx=document.getElementById("nx");
    const au=document.getElementById("au");
    let can=false;

    function play(){
      sp.src = STIM + "speaker_playing.png";
      au.currentTime=0;
      au.play().catch(()=>{});
    }

    sp.onclick=play;

    au.onended=()=>{
      sp.src = STIM + "speaker.png";
      can=true;
      setNextEnabled(true);
    };

    nx.onclick=()=>{
      if(!can) return;
      jsPsych.finishTrial();
    };
  }
};

function layoutStimulus(row, mode){
  const img3 = row.image3 || "";
  const img2 = row.image2 || "";
  const a1 = row.article1 || "";
  const a2 = row.article2 || "";
  const c1 = row.color1 || "red";
  const c2 = row.color2 || "blue";

  const taskSpeakerHtml = mode === "clickable"
    ? `<img id="spTask" class="taskSpeaker" src="${STIM}speaker.png">`
    : ``;

  return `
    <div class="wrap">
      <div class="topRow" style="flex-direction:column; gap:12px;">
  ${taskSpeakerHtml}
  <div class="topLabel">G3</div>
<div class="tile grayBg" id="topImg3Tile">
          <img class="stim" id="topImg3" src="${STIM}${img3}">
          <img class="highlight" id="hl_topImg3" src="${STIM}highlight_box_orange.png">
        </div>
      </div>

      <div class="tileRow">
        <div class="tile grayBg ${mode}" id="tile_img2">
          <img class="stim" id="img2" src="${STIM}${img2}">
          <img class="highlight" id="hl_img2" src="${STIM}highlight_box_orange.png">
        </div>

        <div class="tile ${mode}" id="tile_a1">
          <div class="articleTxt" id="a1" style="color:${c1}">${a1}</div>
          <img class="highlight" id="hl_a1" src="${STIM}highlight_box_orange.png">
          <img class="highlight" id="yl_a1" src="${STIM}highlight_box_yellow.png">
        </div>

        <div class="tile ${mode}" id="tile_a2">
          <div class="articleTxt" id="a2" style="color:${c2}">${a2}</div>
          <img class="highlight" id="hl_a2" src="${STIM}highlight_box_orange.png">
          <img class="highlight" id="yl_a2" src="${STIM}highlight_box_yellow.png">
        </div>

        <div class="tile grayBg ${mode}" id="tile_img3">
          <img class="stim" id="img3" src="${STIM}${img3}">
          <img class="highlight" id="hl_img3" src="${STIM}highlight_box_orange.png">
        </div>
      </div>

      <div class="navRow">
        <img id="nx" class="disabled" src="${STIM}next_empty.png" data-enabled="0">
      </div>
    </div>
  `;
}

function exampleTrial(row){
  return {
    type:"html-button-response",
    choices:[],
    stimulus: layoutStimulus(row, ""),
    on_load: async function(){

      setNextEnabled(false);

      const correct = row.correct_article;
      const correctAudio =
        correct === "article1" ? row.article1_audio : row.article2_audio;

      showHL("hl_topImg3");
      await playAudio(row.pre_sentence);
      hideHL("hl_topImg3");

      showHL("hl_topImg3");
      await playAudio(row.image3_audio);
      hideHL("hl_topImg3");

      showHL("hl_img2");
      await playAudio(row.image2_audio);
      hideHL("hl_img2");

      const artHL = correct === "article1" ? "hl_a1" : "hl_a2";
      showHL(artHL);
      await playAudio(correctAudio);
      hideHL(artHL);

      showHL("hl_img3");
      await playAudio(row.image3_audio);
      hideHL("hl_img3");

      setNextEnabled(true);
      document.getElementById("nx").onclick = ()=>jsPsych.finishTrial();
    }
  };
}

function taskTrial(row){
  return {
    type:"html-button-response",
    choices:[],
    stimulus: layoutStimulus(row, "clickable"),
    on_load: function(){

      const correct = row.correct_article;
      let attempts = 0;
      let chosen = null;
      let locked = false;
      let preDone = false;
let speakerHeard = false;   // <<< NEU

      const nx = document.getElementById("nx");
      setNextEnabled(false);

      const tileA1 = document.getElementById("tile_a1");
      const tileA2 = document.getElementById("tile_a2");

      function hideYellow(){
  const y1 = document.getElementById("yl_a1");
  const y2 = document.getElementById("yl_a2");
  if(y1) y1.style.display = "none";
  if(y2) y2.style.display = "none";
}


      function clearBadOutlines(){
        tileA1.classList.remove("chosenBad");
        tileA2.classList.remove("chosenBad");
      }

      function resetChoice(){
        chosen = null;
        hideYellow();
        clearBadOutlines();
        setNextEnabled(false);
      }

      async function highlightPlay(hl, audio){
        showHL(hl);
        await playAudio(audio);
        hideHL(hl);
      }

    

      async function playPreSentence(){
  if(locked) return;
  locked = true;

  const spTask = document.getElementById("spTask");
  if(spTask) spTask.src = STIM + "speaker_playing.png";

  await highlightPlay("hl_topImg3", row.pre_sentence);

  if(spTask) spTask.src = STIM + "speaker.png";
  preDone = true;
  speakerHeard = true;
  locked = false;

  if(chosen){
    setNextEnabled(true);
  }
}

async function clickTopImg3(){
  if(locked) return;

  if(!preDone){
    await playPreSentence();
    return;
  }

  locked = true;
  await highlightPlay("hl_topImg3", row.image3_audio);
  locked = false;
}

      async function clickBottomImg3(){
        if(locked) return;
        locked = true;

        if(!preDone){
          await playPreSentence();
        } else {
          await highlightPlay("hl_img3", row.image3_audio);
        }

        locked = false;
      }

      async function clickImg2(){
        if(locked) return;
        locked = true;
        await highlightPlay("hl_img2", row.image2_audio);
        locked = false;
      }

      async function chooseArticle(which){
        if(locked) return;
        locked = true;

        resetChoice();
        chosen = which;

        if(which === "article1"){
          showHL("yl_a1");
          await highlightPlay("hl_a1", row.article1_audio);
        } else {
          showHL("yl_a2");
          await highlightPlay("hl_a2", row.article2_audio);
        }

if(speakerHeard){
  setNextEnabled(true);
}
        locked = false;
      }

      nx.onclick = async ()=>{
        if(nx.dataset.enabled!=="1") return;
        if(!chosen) return;

        attempts++;

        const chosenTile = (chosen === "article1") ? tileA1 : tileA2;

        if(chosen === correct){
          nx.src = STIM + "stars.png";
          await playAudio("stars_correct.mp3");
          await playAudio(row.whole_sentence);
          jsPsych.finishTrial();
          return;
        }

hideYellow();
clearBadOutlines();
chosenTile.classList.add("chosenBad");

        if(attempts === 1){
  await playAudio(row.incorrect_first_time);

  hideYellow();
  clearBadOutlines();

  chosen = null;
  setNextEnabled(false);
  return;
}



        await playAudio(row.incorrect_second_time);

// roten Rahmen weg
clearBadOutlines();
hideYellow();

// korrekten Artikel gelb anzeigen
if(correct === "article1"){
  showHL("yl_a1");
} else {
  showHL("yl_a2");
}

// ganzen Satz abspielen
await playAudio(row.whole_sentence);

jsPsych.finishTrial();

      };

      const spTask = document.getElementById("spTask");
      if(spTask) spTask.onclick = playPreSentence;

      document.getElementById("topImg3Tile").onclick = clickTopImg3;
      document.getElementById("tile_img2").onclick = clickImg2;

      tileA1.onclick = ()=>chooseArticle("article1");
      tileA2.onclick = ()=>chooseArticle("article2");
    }
  };
}

const end = {
  type:"html-button-response",
  choices:[],
  stimulus:`
    <div class="wrap">
      <div class="topRow">
        <div class="topLabel">G3</div>
      </div>
      <div class="center" style="margin-top:20px;">
        <img src="${STIM}i_002.jpg" style="width:320px;border-radius:18px;">
      </div>
      <div class="navRow">
        <img id="nx" src="${STIM}next.png">
      </div>
      <audio id="au" src="${STIM}${general.goodbye_audio || ""}"></audio>
    </div>
  `,
  on_load(){
    const au=document.getElementById("au");
    if(au && au.src) au.play().catch(()=>{});
    document.getElementById("nx").onclick=()=>jsPsych.finishTrial();
  }
};

const timeline = [];
timeline.push(title);
examples.forEach(r=>timeline.push(exampleTrial(r)));
tasks.forEach(r=>timeline.push(taskTrial(r)));
timeline.push(end);

jsPsych.init({
  timeline,
  display_element:"jspsych-target"
});

})();
</script>
</body>
</html>
