<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>SPEAK W6 A3</title>

<!--
  jsPsych core library (v6.3.1).
  Responsible for timeline execution, trial lifecycle, and rendering.
-->
<script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>

<!--
  jsPsych plugin: html-button-response.
  Used as a generic HTML container; responses are handled manually via JS.
-->
<script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>

<!--
  Default jsPsych CSS.
-->
<link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">

<!--
  PapaParse library for client-side CSV loading and parsing.
-->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!--
  Google Font: ABeeZee.
-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ABeeZee&display=swap" rel="stylesheet">

<style>
/*
  Global page reset.
*/
body{ background:#fff; margin:0; padding:0; }

/*
  Utility class for center-aligned text.
*/
.center{ text-align:center; }

/*
  Force font consistency within jsPsych content.
*/
.jspsych-display-element,
.jspsych-display-element *{
  font-family:"ABeeZee", sans-serif;
}

/*
  Top bar containing speaker icon and task label.
*/
.topBar{
  height:150px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

/*
  Task identifier shown in the top-right corner.
*/
.taskLabel{
  position:absolute;
  right:20px;
  top:18px;
  font-size:20px;
}

/*
  Speaker icon for question playback.
*/
.topSpeaker img{
  height:120px;
  cursor:pointer;
}

/*
  Central stimulus container.
*/
.midBox{
  width:480px;
  height:360px;
  margin:28px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

/*
  Main stimulus image.
*/
.midBox img.stim{
  max-width:420px;
  max-height:300px;
  cursor:pointer;
  z-index:1;

  border:6px solid #2f3438;
  border-radius:26px;
  background:#d8d8d8;
  box-sizing:border-box;
}





/*
  Bottom row containing answer options and confirm button.
*/
.bottomRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:24px;
}

/*
  Answer option icons.
*/
.optBox img{
  width:190px;
  cursor:pointer;
}

/*
  Visual feedback states.
*/
.yellow{ outline:14px solid #ffd400; border-radius:22px; }
.red{ outline:14px solid #e10000; border-radius:22px; }
.green{ outline:14px solid #1aa64a; border-radius:22px; }

/*
  Central confirmation button.
*/
.centerBar img{
  width:220px;
  cursor:pointer;
}

/*
  Disabled state for the confirmation button.
*/
.centerBar.disabled img{
  pointer-events:none;
}

.speakLogo{
  height: 90px;
  display: block;
  margin: 0 auto 12px auto;
}

/*
  Highlight overlay for the main stimulus.
*/
.stim-highlight {
  outline: 12px solid #ff7a18;
  outline-offset: 8px;
  border-radius: 26px;
}

</style>
</head>

<body>

<!--
  jsPsych will render all experiment content into this container.
-->
<div id="jspsych-target"></div>

<script>
/*
  Base path constants.
  Centralized for maintainability and deployment flexibility.
*/
const BASE = "./";
const DATA=BASE+"data/";
const STIM=BASE+"stimuli_F_1/";

/* ---------- CSV LOADER ---------- */
/*
  Loads a CSV file via PapaParse.
  Filters out empty or whitespace-only rows.
*/
function loadCSV(url){
  return new Promise(resolve=>{
    Papa.parse(url,{
      header:true,
      download:true,
      complete:r=>{
        const rows=(r.data||[]).filter(x =>
          x && Object.values(x).some(v=>String(v||"").trim()!=="")
        );
        resolve(rows);
      }
    });
  });
}

(async function(){

/* ---------- LOAD DATA ---------- */
/*
  Load general configuration and task trials from CSV files.
*/
const general = (await loadCSV(DATA+"K2_W6_A3_general.csv"))[0];
const trials  = (await loadCSV(DATA+"K2_W6_A3_task.csv"))
  .filter(r=>r.image1);

/* ---------- START SCREEN ---------- */
/*
  Introductory screen.
  Forces listening to the explanation audio before proceeding.
*/
const start={
  type:"html-button-response",
  choices:[],
  stimulus:`
    <div class="center" style="margin-top:10px;">
                    <img class="speakLogo" src="${STIM}SPEAK_transparenter_HG.png" alt="SPEAK Logo">

      <h1>Willkommen – SPEAK Woche ${general.week}</h1>
      <p>Hör dir die Erklärung an.</p>

      <img id="sImg"
     src="${STIM}Week6_A3.png"
     style="width:560px;border:6px solid #999;border-radius:18px;cursor:pointer;">


      <br><br>

      <img id="sSp" src="${STIM}speaker.png"
           style="height:120px;cursor:pointer">

      <br><br>

<div id="sNextWrap" style="display:none;">
  <img id="sNext" src="${STIM}next.png"
       style="height:120px;cursor:pointer">
</div>


      <audio id="sAu" src="${STIM}${general.explanation_audio}"></audio>
    </div>
  `,
  on_load(){
  const sp = document.getElementById("sSp");
  const nx = document.getElementById("sNext");
  const au = document.getElementById("sAu");
  const img = document.getElementById("sImg");
  const wrap = document.getElementById("sNextWrap");

  let canGo = false;
  let playing = false;

  function play(){
    if(playing) return;
    playing = true;

    sp.src = STIM + "speaker_playing.png";
    au.currentTime = 0;
    au.play().catch(()=>{});
  }

  sp.onclick = play;
  if(img) img.onclick = play;

  au.onended = () => {
    sp.src = STIM + "speaker.png";
    playing = false;
    canGo = true;
    if(wrap) wrap.style.display = "block";
  };

  nx.onclick = () => {
    if(!canGo) return;
    jsPsych.finishTrial();
  };
}

};

/* ---------- TASK TRIAL FACTORY ---------- */
/*
  Creates a single interactive task trial.
*/
function makeTrial(t){
  return{
    type:"html-button-response",
    choices:[],
    stimulus:`
      <div class="wrap">
        <div class="topBar">
          <div class="topSpeaker">
            <img id="qSpImg" src="${STIM}speaker.png">
          </div>
          <div class="taskLabel">A3</div>
        </div>

        <div class="midBox">
  <div id="stimWrap">
    <img id="stim" class="stim" src="${STIM}${t.image1}">
  </div>
</div>


        <div class="bottomRow">
          <div class="optBox">
            <img id="L" src="${STIM}speaker_response_option.png">
          </div>

          <div class="centerBar disabled">
            <img id="C" src="${STIM}next_small_empty.png">
          </div>

          <div class="optBox">
            <img id="R" src="${STIM}speaker_response_option.png">
          </div>
        </div>

        <audio id="qAu" src="${STIM}${t.question}"></audio>
      </div>
    `,
    on_load(){
      const qSpImg = document.getElementById("qSpImg");
      const stim   = document.getElementById("stim");
      const midHL  = document.getElementById("midHL");
      const qAu    = document.getElementById("qAu");
      const L      = document.getElementById("L");
      const R      = document.getElementById("R");
      const C      = document.getElementById("C");

      /*
        State variables controlling trial logic.
      */
     let audioBusy = false;
      let attempt = 1;
      let selected = null;
      let locked = false;
      let heard = { L:false, R:false };

      /*
        Mapping of left/right options to audio and correctness.
      */
      const map = {
        L:{ audio:new Audio(STIM + t.audio_target), correct:true },
        R:{ audio:new Audio(STIM + t.audio_distractor), correct:false }
      };

      /*
        Plays the question audio and highlights the stimulus.
      */
  function playQuestion(){
  if(locked || audioBusy) return;

  audioBusy = true;
  locked = true;

  qSpImg.src = STIM + "speaker_playing.png";
  stim.classList.add("stim-highlight");

  qAu.currentTime = 0;
  qAu.play().catch(()=>{});

  qAu.onended = ()=>{
    qSpImg.src = STIM + "speaker.png";
    stim.classList.remove("stim-highlight");
    audioBusy = false;
    locked = false;
  };
}


      /*
        Handles selection of an answer option.
        Requires both options to be heard before enabling confirmation.
      */
      function pick(side){
        if(audioBusy) return;
audioBusy = true;
        if(locked) return;
        selected = side;
        heard[side] = true;

        L.classList.remove("yellow","red","green");
        R.classList.remove("yellow","red","green");

        document.getElementById(side).classList.add("yellow");
        map[side].audio.currentTime = 0;
        map[side].audio.play();
map[side].audio.onended = ()=>{
  audioBusy = false;
};

        if(heard.L && heard.R){
          C.src = STIM + "next_small.png";
          C.parentElement.classList.remove("disabled");
        }
      }

      /*
        Handles correct answer feedback and ends the trial.
      */
      function correct(){
        locked = true;
        document.getElementById(selected).classList.add("green");
        C.src = STIM + "stars.png";
        const a = new Audio(STIM + t.fb_correct);
        a.play();
        a.onended = ()=>jsPsych.finishTrial();
      }

      /*
        Shuffles left/right audio assignment after first incorrect attempt.
      */
      function shuffleOptions(){
        C.src = STIM + "reshuffle.png";
        C.parentElement.classList.add("disabled");

        const s = new Audio(STIM + "shuffle.wav");
        s.play().catch(()=>{});

        [map.L, map.R] = [map.R, map.L];

        s.onended = ()=>{
          C.src = STIM + "next_small_empty.png";
        };
      }

      /*
        Handles incorrect answer logic.
      */
      function wrong(){
        locked = true;
        document.getElementById(selected).classList.add("red");

        const fb = new Audio(
          STIM + (attempt===1
            ? t.fb_incorrect_first_try
            : t.fb_incorrect_second_try)
        );

        fb.play();
        fb.onended = ()=>{
          if(attempt === 1){
            attempt = 2;
            L.classList.remove("yellow","red","green");
            R.classList.remove("yellow","red","green");
            selected = null;
            heard = {L:false, R:false};

            shuffleOptions();
            locked = false;
            playQuestion();
          } else {
            jsPsych.finishTrial();
          }
        };
      }

      /*
        Event bindings.
      */
      qSpImg.onclick = playQuestion;
      stim.onclick   = playQuestion;
      L.onclick      = ()=>pick("L");
      R.onclick      = ()=>pick("R");
      C.onclick      = ()=> map[selected]?.correct ? correct() : wrong();

      /*
        Automatically play the question at trial start.
      */
      playQuestion();
    }
  };
}

/* ---------- END SCREEN ---------- */
/*
  Final feedback and goodbye screen.
*/
const endScreen={
  type:"html-button-response",
  choices:[],
  stimulus:`
    <div class="center" style="margin-top:80px;">
      <h2>Geschafft!</h2>
      <p>Das hast du super gemacht!</p>
      <img src="${STIM}i_002.jpg"
           style="max-width:300px;margin-top:20px;border-radius:12px;">
      <div style="margin-top:24px;">
        <img id="endNext" src="${STIM}next.png"
             style="width:200px;cursor:pointer">
      </div>
      <audio id="byeAu" src="${STIM}${general.goodbye_audio || ""}"></audio>
    </div>
  `,
  on_load(){
    const au=byeAu;
    if(au && au.src) au.play().catch(()=>{});
    endNext.onclick=()=>jsPsych.finishTrial();
  }
};

/* ---------- TIMELINE ---------- */
/*
  Assemble the jsPsych timeline.
*/
const timeline=[start];
trials.forEach(t=>timeline.push(makeTrial(t)));
timeline.push(endScreen);

/*
  Initialize jsPsych and start the experiment.
*/
jsPsych.init({
  timeline,
  display_element:"jspsych-target"
});

})();
</script>
</body>
</html>
