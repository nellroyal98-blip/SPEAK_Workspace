<!DOCTYPE html>
<!--
  SPEAK Woche 1 – Fully annotated, developer-focused walkthrough.
  All annotations explain high-level design and low-level logic.
  The goal is to enable extension and debugging by other coders.
-->
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>SPEAK Woche 1</title>

  <!-- jsPsych core library. -->
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">
  <!-- jsPsych plugin for HTML trials with button interactions. -->
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <!-- PapaParse is used for CSV loading. -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ABeeZee&display=swap" rel="stylesheet">
  <style>
    /* Basic UI styling. Color scheme tuned to SPEAK design. */
    body {
  background:#fcfcfc;
  margin: 0;
}

/* UI helpers bleiben unverändert */
.center { text-align:center; }
.hide { display:none !important; }

/* HIER passiert die Typografie */
.jspsych-display-element,
.jspsych-display-element * {
  font-family: "ABeeZee", sans-serif;
}

    /* Next button and icon style. */
    .next-btn { background:none; border:none; cursor:pointer; }
    .next-btn img { height:56px; vertical-align: middle; }

    /* Speaker icon for audio play. */
    .speaker-btn { background:none; border:none; outline:none; cursor:pointer; }
    .speaker-btn img { height:70px; transition: filter 0.1s; }

    /* Story image presentation. */
    .story-img { display:block; margin:18px auto; width:800px; max-width:95%; border-radius:12px; }

    /* Clickable highlight for definitions (target stage). */
    .clickable { cursor:pointer; box-shadow:0 0 0 6px rgba(80,200,120,0.25); }
    .info { color:#666; font-size:0.95em; margin-top:8px; }

    /* Visual highlight when playing definition audio. */
    .playing-orange { box-shadow: 0 0 0 10px rgba(255,140,0,0.9) !important; border-radius:12px; }

    /* Grid for V2 4-image multiple choice interaction. */
    .img-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  gap:44px;
  justify-content:center;
  margin:40px auto;
  max-width:800px;     /* vorher 600px */
}
.img-grid img {
  width:300px;         /* vorher 235px */
  border:5px solid transparent;
  border-radius:18px;
  transition:border 0.2s;
  cursor:pointer;
}    .img-grid img.green { border-color:#4caf50 !important; background:#e9fbe9; }
    .img-grid img.red { border-color:#f44336 !important; background:#ffeaea; }
    .img-grid img.yellow { border-color:#ffc107 !important; background:#fffbe4; }

    /* Instruction and final big images. */
    .big-instr { display:block; margin:0 auto 18px auto; height:500px; }
    .final-big { display:block; margin:0 auto 18px auto; height:380px; }

    
  </style>
</head>
<body>
  <!-- jsPsych render target container. -->
  <div id="jspsych-target"></div>

<script>
/* ===============================
   HELPER FUNCTIONS (GLOBAL UTILS)
   =============================== */

/* Timestamp helper for logging. */
function now(){ return new Date().toISOString(); }

/* Manual CSV loader for V1, semicolon-separated, preserving blank columns as empty strings. */
async function loadCSV_lines(url){
  const resp = await fetch(url);
  if(!resp.ok) throw new Error("Fehler beim Laden der CSV: "+resp.status);
  const text = await resp.text();

  /* Split by lines, detect header row (skip initial blanks). */
  const raw = text.split(/\r?\n/);
  let headerIdx = null;
  for(let i=0;i<raw.length;i++){ if(raw[i].trim()!==""){ headerIdx = i; break; } }
  if(headerIdx === null) return [];

  /* Header fields. */
  const header = raw[headerIdx].split(";").map(h=>h.trim());
  const out = [];

  for(let i=headerIdx+1;i<raw.length;i++){
    const line = raw[i].trim();
    if(!line) continue;
    const parts = line.split(";").map(p=>p.trim());
    const obj = {};
    for(let j=0;j<header.length;j++) obj[header[j]] = parts[j] || "";
    out.push(obj);
  }
  return out;
}

/* PapaParse-based CSV loader for V2 and later tables. */
function loadCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, {
      header:true,
      download:true,
      complete: r => resolve(r.data || []),
      error: err => reject(err)
    });
  });
}

/* Creates an HTMLAudioElement with preload. */
function makeAudio(src){ try{ const a=new Audio(src); a.preload='auto'; return a; }catch(e){ return null; } }

/* Play HTMLAudioElement reliably, resolving on end or error. */
function playAudio(elem){
  return new Promise(resolve => {
    if(!elem) return resolve({status:"no_element"});

    /* Reset audio position if previously partially played. */
    try{ elem.pause(); elem.currentTime=0; }catch(e){}

    let p;
    try{ p = elem.play(); }catch(e){ return resolve({status:"play_throw", error:e}); }

    /* Modern browsers may return a promise for autoplay; handle block. */
    if(p && typeof p.then === "function") p.then(()=>{}).catch(err => resolve({status:"blocked", error:err}));

    /* Setup cleanup. */
    function cleanup(res){ elem.removeEventListener('ended', ended); elem.removeEventListener('error', onErr); resolve(res); }
    function ended(){ cleanup({status:"ended"}); }
    function onErr(e){ cleanup({status:"error", error:e}); }
    elem.addEventListener('ended', ended);
    elem.addEventListener('error', onErr);
  });
}

/* Audio lock mechanism to serialize audio playback when necessary. */
window.__audioLock = { busy:false, queue:[] };
function acquireAudioLock(){ return new Promise(res => {
  if(!window.__audioLock.busy){ window.__audioLock.busy=true; return res(); }
  window.__audioLock.queue.push(res);
}); }
function releaseAudioLock(){ if(window.__audioLock.queue.length) window.__audioLock.queue.shift()(); else window.__audioLock.busy = false; }

/* Detect initial user interaction; required to unlock audio on mobile/Chrome. */
let __userInteractedResolve;
const __userInteracted = new Promise(res => { __userInteractedResolve = res; });
function enableUserInteractionListener(){
  function once(){ window.removeEventListener('click', once); window.removeEventListener('keydown', once); __userInteractedResolve(); }
  window.addEventListener('click', once, { once:true });
  window.addEventListener('keydown', once, { once:true });
}
function waitForUserInteraction(){ return __userInteracted; }

/* In-place shuffle returning {arr}. Used for V2 random order of 4 images. */
function shuffleWithKey(arr){ let m = arr.length, t, i; while(m){ i = Math.floor(Math.random()*m--); t = arr[m]; arr[m] = arr[i]; arr[i] = t; } return {arr}; }


/* ===============================
   V2 TRIAL FACTORY
   Creates interactive 4-option picture choice trials with audio.
   =============================== */
function makeV2Trial(trial, idx){
  return {
    type: "html-button-response",
    stimulus: function(){
      /* Build speaker button and audio. */
      const speakerHtml = `
        <audio id="vocab-audio" src="stimuli/${trial.audio}"></audio>
        <button id="play-vocab-audio" class="speaker-btn" style="display:block; margin:0 auto 10px auto;">
          <img src="stimuli/speaker.png" alt="Play">
        </button>`;

      /* Collect main target and 3 distractors; shuffle to randomize placement. */
      const imgs = [
        {file: trial.target, correct:true},
        {file: trial.image_2, correct:false},
        {file: trial.image_3, correct:false},
        {file: trial.image_4, correct:false}
      ];
      const {arr} = shuffleWithKey(imgs);

      /* Store ordering for trial.data output. */
      trial._images = arr;
      trial._correctIndex = arr.findIndex(x => x.correct);

      /* Initial render: pointer-events disabled until main audio finishes. */
      const grid = `<div class="img-grid">` + arr.map((im,i)=>
        `<img src="stimuli/${im.file}" data-idx="${i}" data-correct="${im.correct?1:0}" style="pointer-events:none; opacity:0.7;">`
      ).join('') + `</div>`;

      return speakerHtml + grid;
    },
    choices: [],  // controlled via code only
    data: { trial_index: idx },
    on_load: function(){
      /* DOM references */
      const btn = document.getElementById("play-vocab-audio");
      const audio = document.getElementById("vocab-audio");
      const imgs = document.querySelectorAll(".img-grid img");
 function resetAfterMainAudio(){
        imgs.forEach(im => { im.style.pointerEvents = "auto"; im.style.opacity = "1"; });
        btn.querySelector('img').src = "stimuli/speaker.png";
        document.body.style.cursor = "";
      }
      /* Show playing icon, hide pointer, auto-play initially. */
      btn.querySelector('img').src = "stimuli/speaker_playing.png";
      document.body.style.cursor = "none";
      audio.play();

      /* Re-enable choice after audio finishes. */
       audio.onended = function(){
        resetAfterMainAudio();
      };

      /* Replay audio on speaker click (disables choices while playing). */
      btn.addEventListener('click', function(){
        btn.querySelector('img').src = "stimuli/speaker_playing.png";
        imgs.forEach(im => { im.style.pointerEvents = "none"; im.style.opacity = "0.7"; });
        document.body.style.cursor = "none";
        audio.currentTime = 0;
        audio.play();
      });

      /* Wrong-answer escalation: 1st wrong -> hint audio; 2nd -> show correct item. */
      let locked = false; let errors = 0; const correctIdx = trial._correctIndex;
      imgs.forEach((img, i) => {
        img.addEventListener('click', () => {
          if(img.style.pointerEvents === "none" || locked) return;
          locked = true;

          const ok = img.getAttribute('data-correct') === "1";
          if(ok){
            img.classList.add('green');
            new Audio("stimuli/stars_correct.mp3").play();
            /* Finish with success information returned via finishTrial. */
            setTimeout(()=> jsPsych.finishTrial({ correct:true, chosen_index:i, correct_index:correctIdx, chosen_image: img.src, images: trial._images.map(x=>x.file) }), 900);
          } else {
            img.classList.add('red');
            errors++;
             if(errors === 1){
              /* Erster Fehler: Feedback-Audio, dann Vokabelaudio noch einmal wie zu Beginn. */
              const fb = new Audio("stimuli/" + trial.followup_audio_first_false_answer);
              fb.play();
              fb.onended = () => {
                // Alles sperren und ausgrauen, wie am Trial-Start
                imgs.forEach(im => {
                  im.style.pointerEvents = "none";
                  im.style.opacity = "0.7";
                });
                btn.querySelector('img').src = "stimuli/speaker_playing.png";
                document.body.style.cursor = "none";

                // Vokabelaudio (Hauptaudio) von vorne abspielen
                try { audio.currentTime = 0; } catch(e) {}
                const oldOnEnded = audio.onended;
                audio.onended = function(){
                  // normales Re-Enable
                  resetAfterMainAudio();
                  // Rot-Markierung zurücksetzen, neue Antwort erlauben
                  img.classList.remove('red');
                  locked = false;
                  // onended zurücksetzen, damit spätere Abspielvorgänge wieder wie gewohnt laufen
                  audio.onended = oldOnEnded;
                };
                audio.play();
              };
            } else {
              /* Second wrong attempt: highlight correct option and finish. */
              setTimeout(() => {
                img.classList.remove('red');
                imgs[correctIdx].classList.add('yellow');
                const b = new Audio("stimuli/" + trial.followup_audio_second_false_answer);
                b.play();
                b.onended = () => setTimeout(() => jsPsych.finishTrial({ correct:false, chosen_index:i, correct_index:correctIdx, chosen_image: img.src, images: trial._images.map(x=>x.file) }), 600);
              }, 350);
            }
          }
        });
      });
    }
  };
}


/* ===============================
   V3 (Wiederholungsübung) BLOCK
   Audio repetition and confirmation tasks, including star feedback overlay.
   =============================== */
function startWiederholungsuebung(trialsData, timeline){

  /* V3 instruction screen: shows big instruction image and audio; next unlocks after audio end. */
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_265.jpg" class="big-instr">
      <audio id="v3-instr-audio" src="stimuli/ai_006.mp3"></audio>
      <div style="text-align:center; margin-top:12px;">
        <button class="next-btn hide" id="v3-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>
      </div>
    `,
    choices: [],
    on_load: function(){
      const audio = document.getElementById("v3-instr-audio");
      const nextBtn = document.getElementById("v3-next-btn");
      document.body.style.cursor = "none";
      audio.play();
      audio.onended = () => { nextBtn.classList.remove('hide'); document.body.style.cursor = ""; };
      nextBtn.onclick = function(){ jsPsych.finishTrial(); };
    }
  });

  /* Randomized main trials for V3: highlight target image while audio plays. */
  const usable = trialsData.filter(r => r && r.audio && r.target);
  const {arr: shuffled} = shuffleWithKey(usable);

  shuffled.forEach((trial) => {
    timeline.push({
      type: "html-button-response",
      stimulus: function(){
        /* Large overlay with orange highlight behind target. */
        return `
          <div style="position:relative; height:420px;">
            <img src="stimuli/highlight_box_gray_large.png" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:345px; z-index:1;">
            <img src="stimuli/${trial.target}" id="repeat-img" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:235px; z-index:2;">
            <img src="stimuli/highlight_box_orange_large.png" id="highlight-orange" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:345px; z-index:3;">
          </div>
          <audio id="repeat-audio" src="stimuli/${trial.audio}"></audio>
          <div id="repeat-next-btn" class="hide" style="text-align:center; margin-top:36px;">
            <button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>
          </div>
        `;
      },
      choices: [],
        on_load: function(){
      const audio = document.getElementById("repeat-audio");
      const nextBtnDiv = document.getElementById("repeat-next-btn");
      const highlightOrange = document.getElementById("highlight-orange");
      const nextBtn = nextBtnDiv.querySelector("button");
      const img = document.getElementById("repeat-img");

      /* Gemeinsame Logik für jeden Durchlauf des Vokabel Audios */
      function playRepeatAudio() {
        // Alles so aussehen lassen wie bei einem neuen Stimulus
        if (highlightOrange) highlightOrange.classList.remove('hide');
        if (nextBtnDiv) nextBtnDiv.classList.add('hide');
        document.body.style.cursor = "none";

        if (img) img.style.pointerEvents = "none";

        try { audio.currentTime = 0; } catch(e){}
        audio.play();
      }

      // Bild klickbar machen: bei jedem Klick wird das Audio erneut gestartet
      if (img) {
        img.style.cursor = "pointer";
        img.addEventListener('click', function(){
          playRepeatAudio();
        });
      }

      // Initiales automatisches Abspielen beim Start des Trials
      playRepeatAudio();

      audio.onended = function(){
        // Nach Audioende wieder Zustand wie "bereit zum Weiterklicken"
        if (highlightOrange) highlightOrange.classList.add('hide');
        if (nextBtnDiv) nextBtnDiv.classList.remove('hide');
        document.body.style.cursor = "";
        if (img) img.style.pointerEvents = "auto";
      };

      nextBtn.onclick = function(){
        const feedbackDiv = document.createElement('div');
        feedbackDiv.style = "position:fixed; left:0;top:0;width:100vw;height:100vh;z-index:10000;background:rgba(255,255,255,0.94);display:flex;flex-direction:column;align-items:center;justify-content:center;";
        feedbackDiv.innerHTML = `<img src="stimuli/stars.png" style="width:190px;"><audio id="star-feedback" src="stimuli/stars_correct.mp3" autoplay></audio>`;
        document.body.appendChild(feedbackDiv);

        const starAudio = feedbackDiv.querySelector('#star-feedback');
        let finished = false;
        
        function finishNow(){
          if(!finished){
            if(document.body.contains(feedbackDiv)) document.body.removeChild(feedbackDiv);
            jsPsych.finishTrial();
            finished = true;
          }
        }

        starAudio.onended = function(){ setTimeout(finishNow, 650); };
        setTimeout(finishNow, 1900);
      };
    }

    });
  });

  /* V3 goodbye and closure screen. */
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_002.jpg" class="final-big">
      <h2>Super!</h2>
      <p>Du hast die Wiederholungsübung abgeschlossen.</p>
      <button id="play-v3-goodbye" class="speaker-btn hide"><img src="stimuli/speaker.png" alt="Play"></button>
      <audio id="v3-goodbye-audio" src="stimuli/ai_021.mp3"></audio>
      <div style="text-align:center; margin-top:12px;">
        <button class="next-btn" id="v3-goodbye-next"><img src="stimuli/next.png" alt="Weiter"></button>
      </div>
    `,
    choices: [],
    on_load: function(){
      const audio = document.getElementById("v3-goodbye-audio");
      const nextBtn = document.getElementById("v3-goodbye-next");
      /* Autoplay goodbye (if blocked, fallback to nextBtn). */
      audio.play();
      audio.onended = function(){ nextBtn.onclick = function(){ jsPsych.finishTrial(); }; };
      nextBtn.onclick = function(){ jsPsych.finishTrial(); };
    }
  });
}


/* ===============================
   MAIN ENTRY
   =============================== */
(async function main(){
  /* V1 CSV: sequential story presentation with click-to-define. */
  let v1_rows = [];
  try { v1_rows = await loadCSV_lines('data/K2_W1_V1_task.csv'); }
  catch(e){
    /* If missing, show message and end. */
    jsPsych.init({ timeline:[{ type:"html-button-response", stimulus:"<h2>CSV V1 nicht gefunden</h2>", choices:["OK"] }], display_element:'jspsych-target' });
    return;
  }

  /* V2 CSVs: general info and multiple-choice items. */
  let v2_general = [], v2_trials_raw = [];
  try {
    [v2_general, v2_trials_raw] = await Promise.all([
      loadCSV('data/K2_W1_V2_general.csv'),
      loadCSV('data/K2_W1_V2_task.csv')
    ]);
  } catch(e){ /* fallback to empty */ }

  /* Extract V2 metadata, fallback to default week and assets. */
  const v2_info = Array.isArray(v2_general) && v2_general.length ? v2_general[0] : {};
  const week = v2_info.week || "1";
  const explanationImage = v2_info.explanation_image ? 'stimuli/' + v2_info.explanation_image : 'stimuli/Week1_V2.png';
  const explanationAudio = v2_info.explanation_audio ? 'stimuli/' + v2_info.explanation_audio : 'stimuli/ai_004.mp3';
  const goodbyeAudio = v2_info.goodbye_audio ? 'stimuli/' + v2_info.goodbye_audio : 'stimuli/ai_021.mp3';

  /* Map V1 rows (story, target, definition) to a normalized structure. */
  const storyStimuli = v1_rows
    .filter(r => r && ((r.story_audio||"").trim() || (r.show_on_screen||"").trim()))
    .map(r => ({
      story_audio: (r.story_audio||"").trim(),
      show_on_screen: (r.show_on_screen||"").trim(),
      target: (r.target||"").trim(),
      target_audio: (r.target_audio||"").trim(),
      definition_audio: (r.definition_audio||"").trim()
    }));

  /* -------------------------------------
     V1 Single Trial (sequential story mode)
     ------------------------------------- */
  const v1_singleTrial = {
    type: "html-button-response",
    stimulus: `
      <div class="center">
        <img id="scene" class="story-img" src="stimuli/${storyStimuli[0] ? storyStimuli[0].show_on_screen : 'i_002.jpg'}" alt="Szene">
        <div id="info" class="info">Tippe einmal, um zu starten.</div>
        <div id="nextwrap" class="center hide" style="margin-top:18px;">
          <button id="next" class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>
        </div>
      </div>
    `,
    choices: [],
    on_load: function(){
      const img = document.getElementById('scene');
      const info = document.getElementById('info');
      const nextWrap = document.getElementById('nextwrap');
      const nextBtn = document.getElementById('next');

      enableUserInteractionListener();

      /* Async IIFE running all V1 story items in sequence. */
      (async function runAll(){
        await waitForUserInteraction();  // ensure user gesture

        for(let i=0;i<storyStimuli.length;i++){
          const row = storyStimuli[i];

          /* Step 1: show story image, play story audio. */
          img.src = "stimuli/" + row.show_on_screen;
          info.textContent = "Höre zu.";
          nextWrap.classList.add('hide');

          const aStory = row.story_audio ? makeAudio('stimuli/' + row.story_audio) : null;
          if(aStory){
            await acquireAudioLock();
            try{
              const res = await playAudio(aStory);
              /* If audio blocked, ask user to click image to proceed manually. */
              if(res && res.status === "blocked"){
                await new Promise(resolve => {
                  img.style.cursor = 'pointer';
                  function handler(){
                    img.removeEventListener('click', handler);
                    img.style.cursor = '';
                    acquireAudioLock().then(async ()=>{
                      try{ await playAudio(aStory); }catch(e){}
                      releaseAudioLock(); resolve();
                    });
                  }
                  img.addEventListener('click', handler, { once:true });
                });
              }
            } finally { releaseAudioLock(); }
          }

          /* Step 2: move to target image (vocabulary introduction). */
          if(row.target && (row.target_audio || row.definition_audio)){
            img.src = "stimuli/" + row.target;

            /* Target pronunciation audio. */
            const aTarget = row.target_audio ? makeAudio('stimuli/' + row.target_audio) : null;
            if(aTarget){
              await acquireAudioLock();
              try{
                const tres = await playAudio(aTarget);
                if(tres && tres.status === "blocked"){
                  await new Promise(resolve => {
                    img.style.cursor = 'pointer';
                    function handler(){
                      img.removeEventListener('click', handler);
                      img.style.cursor = '';
                      acquireAudioLock().then(async ()=>{
                        try{ await playAudio(aTarget); }catch(e){}
                        releaseAudioLock(); resolve();
                      });
                    }
                    img.addEventListener('click', handler, { once:true });
                  });
                }
              } finally { releaseAudioLock(); }
            }

/* Step 3: user can click target to hear definition, beliebig oft; orangener Rahmen jedes Mal. */
info.textContent = "Klicke auf das Bild, um die Worterklärung zu hören.";
img.style.pointerEvents = 'auto';
img.classList.add('clickable');

await new Promise(resolve => {
  const defSrc = row.definition_audio ? 'stimuli/' + row.definition_audio : null;
  let firstPlayDone = false;
  let isPlaying = false;

  async function playDefinition() {
    if (!defSrc || isPlaying) return;
    isPlaying = true;

    const aDef = makeAudio(defSrc);
    img.classList.add('playing-orange');
    img.style.pointerEvents = 'none';

    await acquireAudioLock();
    try {
      await playAudio(aDef);
    } finally {
      releaseAudioLock();
      img.classList.remove('playing-orange');
      img.style.pointerEvents = 'auto';
      isPlaying = false;
    }
  }

  img.addEventListener('click', async function onClick(){
    await playDefinition();

    if (!firstPlayDone) {
      // Erstes Mal: Pfeil anzeigen und Ablauf freischalten
      firstPlayDone = true;
      img.classList.remove('clickable');
      info.textContent = "Klicke den grünen Pfeil, um weiterzumachen.";
      nextWrap.classList.remove('hide');

      nextBtn.onclick = function(){
        nextBtn.onclick = null;
        nextWrap.classList.add('hide');
        img.removeEventListener('click', onClick);
        resolve();
      };
    }
    // Weitere Klicks: nur nochmal Definition mit orangem Rahmen,
    // resolve() passiert erst, wenn der Pfeil geklickt wird.
  });
});

          } else {
            /* No target for this row; skip directly to next button. */
            info.textContent = "Klicke den grünen Pfeil, um weiterzumachen.";
            nextWrap.classList.remove('hide');
            await new Promise(r => {
              nextBtn.onclick = function(){ nextBtn.onclick = null; nextWrap.classList.add('hide'); r(); };
            });
          }
        }

        /* End V1 block. */
        info.textContent = "Gut gemacht.";
        setTimeout(() => jsPsych.finishTrial(), 200);
      })().catch(err => {
        console.error("Sequenzfehler V1:", err);
        jsPsych.finishTrial();
      });
    }
  };

  /* -------------------------------------
     V2 Intro Screen
     ------------------------------------- */
  const v2_intro = {
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/SPEAK_transparenter_HG.png" style="height:100px; margin-bottom:18px; display:block; margin-left:auto; margin-right:auto;">
      <h2 style="text-align:center;">Willkommen zur Übung in Woche ${week}</h2>
      <div aria-hidden="true" style="height:1.2em;"></div>
      <div style="display:flex; justify-content:center; align-items:center; margin:24px 0 18px 0;">
        <div style="border:5px solid #4caf50; box-shadow:0 4px 18px rgba(90,180,120,0.16); border-radius:24px; padding:14px 18px 12px 18px; background:#f5fcf5;">
          <img src="${explanationImage}" style="display:block; height:230px; border-radius:16px;">
          <div aria-hidden="true" style="height:1.2em;"></div>
          <div style="text-align:center; font-size:0.95em; color:#348f50; margin-top:6px;">Beispiel</div>
        </div>
      </div>
      <audio id="instr-audio" src="${explanationAudio}"></audio>
      <div aria-hidden="true" style="height:1.2em;"></div>
      <div style="font-size:1.1em; color:#8BC53F; font-weight:bold; margin-top:8px; text-align:center;">
        Bitte höre dir die Aufgabenstellung sorgfältig an. Wenn du bereit bist, klicke auf den grünen Pfeil.
      </div>
      <div style="text-align:center; margin-top:14px;">
        <button class="next-btn hide" id="instr-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>
      </div>
    `,
    choices: [],
    on_load: function(){
      const audio = document.getElementById("instr-audio");
      const nextBtn = document.getElementById("instr-next-btn");
      document.body.style.cursor = "none";
      audio.play();
      audio.onended = () => { nextBtn.classList.remove('hide'); document.body.style.cursor = ""; };
      nextBtn.onclick = function(){ jsPsych.finishTrial(); };
    }
  };

  /* -------------------------------------
     V2 goodbye screen
     ------------------------------------- */
  const goodbyeTrial = {
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_002.jpg" class="final-big">
      <h2>Geschafft</h2>
      <p>Du hast alle Aufgaben abgeschlossen.</p>
      <button id="play-goodbye-audio" class="speaker-btn"><img src="stimuli/speaker.png" alt="Play"></button>
      <audio id="goodbye-audio" src="${goodbyeAudio}"></audio>
      <div style="text-align:center; margin-top:12px;">
        <button class="next-btn" id="goodbye-next"><img src="stimuli/next_small.png" alt="Weiter"></button>
      </div>
    `,
    choices: [],
    on_load: function(){
      const playBtn = document.getElementById("play-goodbye-audio");
      const audio = document.getElementById("goodbye-audio");
      playBtn.addEventListener('click', function(){
        audio.currentTime = 0; audio.play();
        this.querySelector('img').src = "stimuli/speaker_playing.png";
        audio.onended = () => { this.querySelector('img').src = "stimuli/speaker.png"; };
      });
      document.getElementById("goodbye-next").onclick = function(){ jsPsych.finishTrial(); };
    }
  };

  /* -------------------------------------
     BUILD TIMELINE
     ------------------------------------- */
  const v2_trials = (Array.isArray(v2_trials_raw) ? v2_trials_raw : []).filter(r => r && r.audio && r.target);

  const timeline = [];

  /* Custom welcome before everything, ensures user interaction unlock. */
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <div class="center" style="margin-top:24px;">
        <img src="stimuli/SPEAK_transparenter_HG.png" alt="SPEAK" style="height:120px; display:block; margin:0 auto 18px auto;">
        <div style="color:#00000; font-size:1.5em;">Willkommen zur Geschichte in Woche 1!</div>
        <div aria-hidden="true" style="height:1.2em;"></div>
        <div style="color:#348f50; font-size:1.15em;">Klicke auf den grünen Pfeil, um zu starten.</div>
        <div style="margin-top:18px;">
          <button class="next-btn" id="welcome-start"><img src="stimuli/next.png" alt="Start"></button>
        </div>
      </div>
    `,
    choices: [],
    on_load: function(){
      enableUserInteractionListener();
      document.getElementById('welcome-start').onclick = function(){
        try{ if(typeof __userInteractedResolve === 'function') __userInteractedResolve(); }catch(e){}
        jsPsych.finishTrial();
      };
    }
  });

  /* V1 sequential trial set. */
  timeline.push(v1_singleTrial);

  /* If V2 data exists, proceed with V2 intro, V2 blocks, V3, and goodbye. */
  if(v2_trials.length){
    timeline.push(v2_intro);                                       // V2 intro screen
    v2_trials.forEach((t,i)=> timeline.push(makeV2Trial(t,i)));   // First V2 block
    startWiederholungsuebung(v2_trials, timeline);                // V3 repetition block
    v2_trials.forEach((t,i)=> timeline.push(makeV2Trial(t,i)));   // Second V2 block
    timeline.push(goodbyeTrial);                                  // Final goodbye
  } else {
    /* Fallback if V2 missing: end after V1. */
    timeline.push({ type:"html-button-response", stimulus:"<h2>Hinweis</h2><p>V2-Daten fehlen. Session endet nach V1.</p>", choices:["OK"] });
  }

  /* Launch jsPsych with accumulated timeline. */
  jsPsych.init({
    timeline,
    display_element:'jspsych-target',
    on_finish: function(){ jsPsych.data.displayData(); }
  });
})();
</script>
</body>
</html>
