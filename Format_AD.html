<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Woche 10 – G5 jsPsych</title>

  <!-- jsPsych 6.3.1 -->
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <link  href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet"/>
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>

  <!-- CSV Parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body{ 
      background:#fff; 
      font-family:Arial, sans-serif; 
      margin:0;
      padding:0;
    }
    .center{ text-align:center; }

    .next-btn{ 
      background:none; 
      border:none; 
      cursor:pointer; 
    }
    .next-btn img{ 
      height:56px; 
    }

    .speaker-btn{ 
      background:none; 
      border:none; 
      cursor:pointer; 
    }
    .speaker-btn img{ 
      height:60px; 
    }

    .sentence-row{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:20px auto 26px auto;
    }
    .sentence-box{
      width:150px;
      height:150px;
      border:4px solid #333;
      border-radius:16px;
      background:#f3f3f3;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.8em;
      position:relative;
      box-sizing:border-box;
    }
    .sentence-box img{
      max-width:100%;
      max-height:100%;
      border-radius:12px;
    }

    .grid{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:10px auto 30px auto;
      flex-wrap:wrap;
      max-width:950px;
    }
    .tile{
      border-radius:16px;
      border:4px solid #333;
      padding:6px 6px 8px 6px;
      background:#f8f8f8;
      cursor:pointer;
      width:120px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      align-items:center;
      transition:border .15s, background .15s, transform .1s;
    }
    .tile img{
      width:100%;
      height:auto;
      border-radius:10px;
      display:block;
    }
    .tile:hover{
      border-color:#8bc34a;
      background:#eef8e4;
      transform:translateY(-1px);
    }
    .tile.hidden{
      display:none;
    }

    .article-text{
      margin-top:4px;
      font-size:1.2em;
      font-weight:bold;
    }
    .a-die{ color:#e53935; }
    .a-das{ color:#2e7d32; }
    .a-der{ color:#1e88e5; }

    .highlight{
      box-shadow:0 0 0 6px rgba(255,152,0,0.85);
    }

    /* Sterne-Overlay, mittig */
    #stars-overlay{
      position:fixed;
      left:0;
      top:0;
      width:100%;
      height:100%;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      pointer-events:none;
    }
    #stars-overlay img{
      width:260px;
    }
  </style>
</head>
<body>
<div id="jspsych-target"></div>

<div id="stars-overlay">
  <img src="stimuli_AD/stars.png" alt="Stars">
</div>

<script>
  const STIM = "stimuli_AD/";

  function loadCSV(url){
    return new Promise((resolve, reject) => {
      Papa.parse(url, {
        header:true, download:true, skipEmptyLines:true,
        complete: r => resolve(r.data || []),
        error: e => reject(e)
      });
    });
  }

  function playAudio(src){
    return new Promise(res => {
      if(!src){ res(); return; }
      const a = new Audio(src);
      a.onended = () => res();
      a.onerror = () => res();
      a.play().catch(()=>res());
    });
  }

  function articleClass(txt){
    if(!txt) return "";
    const t = txt.trim().toLowerCase();
    if(t === "die") return "a-die";
    if(t === "das") return "a-das";
    if(t === "der" || t === "den") return "a-der";
    return "";
  }

  async function starsSuccess(){
    const overlay = document.getElementById("stars-overlay");
    overlay.style.display = "flex";
    await playAudio(STIM + "stars_correct.mp3");
    await new Promise(r => setTimeout(r, 600));
    overlay.style.display = "none";
  }

  async function flipSentence(){
    await playAudio(STIM + "flip_sound.wav");
  }

  (async function main(){

    let generalRows, exampleRows, taskRows;
    try{
      generalRows = await loadCSV("data/K2_W10_G5_general.csv");
      exampleRows = await loadCSV("data/K2_W10_G5_example.csv");
      taskRows    = await loadCSV("data/K2_W10_G5_task.csv");
    }catch(e){
      alert("CSV-Fehler: "+e);
      return;
    }

    const general = (generalRows && generalRows.length) ? generalRows[0] : {};
    const timeline = [];

    /* ===== Welcome mit Speaker für explanation_audio ===== */
    timeline.push({
      type:"html-button-response",
      choices:[],
      stimulus:`
        <div class="center" style="margin-top:40px;">
          <h2>Woche 10 – Aufgabe G5</h2>
          <p>Hör dir die Erklärung an. Klicke danach auf den Pfeil, um zu starten.</p>

          <div style="margin-top:10px;">
            <button class="speaker-btn" id="welcome-speaker">
              <img src="stimuli_AD/speaker.png" alt="Erklärung anhören">
            </button>
          </div>

          <div style="margin-top:22px;">
            <img src="stimuli_AD/Week10_G5.png"
                 alt="Beispiel"
                 style="max-width:60%;border-radius:12px;border:6px solid #bbbbbb;">
          </div>

          <div style="margin-top:22px;">
            <button class="next-btn" id="welcome-next">
              <img src="stimuli_AD/next.png" alt="Weiter">
            </button>
          </div>
        </div>
      `,
      on_load: function(){
        const sp = document.getElementById("welcome-speaker");
        const btn = document.getElementById("welcome-next");

        if(sp && general.explanation_audio){
          sp.onclick = () => {
            playAudio(STIM + general.explanation_audio);
          };
        }

        if(btn){
          btn.onclick = async () => {
            await flipSentence();
            jsPsych.finishTrial();
          };
        }
      }
    });

    /* ===== Beispiele: alle Zeilen der example-CSV ===== */
    exampleRows.forEach((row, idx) => {
      timeline.push({
        type:"html-button-response",
        choices:[],
        stimulus: function(){

          const img1 = row.image1 ? STIM + row.image1 : "";
          const img2 = row.image2 ? STIM + row.image2 : "";
          const img3 = row.image3 ? STIM + row.image3 : "";
          const article = row.article || "";

          return `
            <div class="center" style="margin-top:10px;">
              <h3>Beispiel ${idx+1}</h3>
              <div class="sentence-row">
                <div class="sentence-box" id="ex-b1">
                  ${img1 ? `<img src="${img1}">` : ""}
                </div>
                <div class="sentence-box" id="ex-b2">
                  ${img2 ? `<img src="${img2}">` : ""}
                </div>
                <div class="sentence-box" id="ex-b3"></div>
                <div class="sentence-box" id="ex-b4"></div>
              </div>
              <button class="speaker-btn" id="ex-play">
                <img src="stimuli_AD/speaker.png" alt="Play">
              </button>
              <div class="center" style="margin-top:10px;">
                <button class="next-btn" id="ex-next" style="display:none;">
                  <img src="stimuli_AD/next.png" alt="Weiter">
                </button>
              </div>
            </div>
          `;
        },
        on_load: function(){

          const b1 = document.getElementById("ex-b1");
          const b2 = document.getElementById("ex-b2");
          const b3 = document.getElementById("ex-b3");
          const b4 = document.getElementById("ex-b4");
          const playBtn = document.getElementById("ex-play");
          const nextBtn = document.getElementById("ex-next");

          const a1 = row.image1_audio ? STIM + row.image1_audio : "";
          const a2 = row.image2_audio ? STIM + row.image2_audio : "";
          const a3 = row.image3_audio ? STIM + row.image3_audio : "";
          const article = row.article || "";
          const img3 = row.image3 ? STIM + row.image3 : "";

          let playing = false;

          if(b1 && a1){
            b1.onclick = async () => {
              if(playing) return;
              playing = true;
              b1.classList.add("highlight");
              await playAudio(a1);
              b1.classList.remove("highlight");
              playing = false;
            };
          }
          if(b2 && a2){
            b2.onclick = async () => {
              if(playing) return;
              playing = true;
              b2.classList.add("highlight");
              await playAudio(a2);
              b2.classList.remove("highlight");
              playing = false;
            };
          }

          if(playBtn){
            playBtn.onclick = async () => {
              if(playing) return;
              playing = true;

              /* image1 + Rahmen */
              if(b1 && a1){
                b1.classList.add("highlight");
                await playAudio(a1);
                b1.classList.remove("highlight");
              }

              /* image2 + Rahmen */
              if(b2 && a2){
                b2.classList.add("highlight");
                await playAudio(a2);
                b2.classList.remove("highlight");
              }

              /* Artikel + Zielbild + Audio */
              if(b3){
                b3.textContent = article;
                b3.classList.add(articleClass(article));
              }
              if(b4 && img3){
                b4.innerHTML = `<img src="${img3}">`;
              }

              if(b3) b3.classList.add("highlight");
              if(b4) b4.classList.add("highlight");
              if(a3){
                await playAudio(a3);
              }
              if(b3) b3.classList.remove("highlight");
              if(b4) b4.classList.remove("highlight");

              await starsSuccess();

              if(nextBtn) nextBtn.style.display = "inline-block";

              playing = false;
            };
          }

          if(nextBtn){
            nextBtn.onclick = async () => {
              await flipSentence();
              jsPsych.finishTrial();
            };
          }
        }
      });
    });

    /* ===== Aufgaben-Trials (taskRows) ===== */
    taskRows.forEach((row, idx) => {
      timeline.push({
        type:"html-button-response",
        choices:[],
        data:{trial_index:idx},
        stimulus: function(){

          const img1 = row.image1 ? STIM + row.image1 : "";
          const img2 = row.image2 ? STIM + row.image2 : "";

          return `
            <div class="center" style="margin-top:10px;">
              <h3>Aufgabe ${idx+1}</h3>
              <div class="sentence-row">
                <div class="sentence-box" id="t-b1">
                  ${img1 ? `<img src="${img1}">` : ""}
                </div>
                <div class="sentence-box" id="t-b2">
                  ${img2 ? `<img src="${img2}">` : ""}
                </div>
                <div class="sentence-box" id="t-b3"></div>
                <div class="sentence-box" id="t-b4"></div>
              </div>
              <button class="speaker-btn" id="t-play">
                <img src="stimuli_AD/speaker.png" alt="Play question">
              </button>
              <div class="grid" id="tiles"></div>
            </div>
          `;
        },
        on_load: function(){

          const box1 = document.getElementById("t-b1");
          const box2 = document.getElementById("t-b2");
          const box3 = document.getElementById("t-b3");
          const box4 = document.getElementById("t-b4");
          const playBtn = document.getElementById("t-play");
          const grid = document.getElementById("tiles");

          const questionAud = row.question ? STIM + row.question : "";
          const a1 = row.audio1 ? STIM + row.audio1 : "";
          const a2 = row.audio2 ? STIM + row.audio2 : "";

          if(box1 && a1){
            box1.onclick = async () => {
              box1.classList.add("highlight");
              await playAudio(a1);
              box1.classList.remove("highlight");
            };
          }
          if(box2 && a2){
            box2.onclick = async () => {
              box2.classList.add("highlight");
              await playAudio(a2);
              box2.classList.remove("highlight");
            };
          }

          if(playBtn){
            playBtn.onclick = async () => {
              /* question + image1 + image2, jedes Mal */
              if(questionAud){
                await playAudio(questionAud);
              }
              if(box1 && a1){
                box1.classList.add("highlight");
                await playAudio(a1);
                box1.classList.remove("highlight");
              }
              if(box2 && a2){
                box2.classList.add("highlight");
                await playAudio(a2);
                box2.classList.remove("highlight");
              }
            };
          }

          const tileData = [];
          const usedArticles = {};
          const clickLog = [];

          for(let i=4;i<=9;i++){
            const imgk = "image"+i;
            if(!row[imgk]) continue;

            const img = STIM + row[imgk];
            const artk = "article"+i;
            const abk  = "article_below"+i;
            const wk   = "whole_sentence_image"+i;
            const aok  = "audio"+i;

            const artBelow = row[abk] || "";
            const art = row[artk] || artBelow;
            const sentence = row[wk] ? STIM + row[wk]
                          : row[aok] ? STIM + row[aok]
                          : "";

            const tile = document.createElement("div");
            tile.className = "tile task-tile";
            tile.innerHTML = `
              <img src="${img}">
              <div class="article-text ${articleClass(art)}">${art}</div>
            `;

            const record = {el: tile, article: art, img: img, sentence: sentence};
            tileData.push(record);

            tile.onclick = async () => {
              const chosenArticle = (art || "").trim();
              if(!chosenArticle) return;
              if(usedArticles[chosenArticle]) return;

              usedArticles[chosenArticle] = true;

              if(box3){
                box3.textContent = chosenArticle;
                box3.className = "sentence-box " + articleClass(chosenArticle);
              }
              if(box4){
                box4.innerHTML = `<img src="${img}">`;
              }

              if(sentence){
                if(box3) box3.classList.add("highlight");
                if(box4) box4.classList.add("highlight");
                await playAudio(sentence);
                if(box3) box3.classList.remove("highlight");
                if(box4) box4.classList.remove("highlight");
              }

              await starsSuccess();
              await flipSentence();

              clickLog.push({
                article: chosenArticle,
                image: img
              });

              tileData.forEach(td => {
                const a = (td.article || "").trim();
                if(a === chosenArticle){
                  td.el.classList.add("hidden");
                }
              });

              if(box3){
                box3.textContent = "";
                box3.className = "sentence-box";
              }
              if(box4){
                box4.innerHTML = "";
                box4.className = "sentence-box";
              }

              const remaining = tileData.filter(td => !td.el.classList.contains("hidden"));
              if(remaining.length === 0){
                jsPsych.finishTrial({
                  trial_index: idx,
                  clicks: clickLog
                });
              }
            };

            if(grid){
              grid.appendChild(tile);
            }
          }

          /* falls diese Zeile keine gültigen Kacheln hat (z.B. leere CSV-Zeile),
             Trial sofort beenden, damit der Goodbye-Screen erreicht wird */
          if(tileData.length === 0){
            jsPsych.finishTrial({
              trial_index: idx,
              clicks: []
            });
          }
        }
      });
    });

    /* ===== Goodbye ===== */
    timeline.push({
      type:"html-button-response",
      choices:[],
      stimulus:`
        <div class="center" style="margin-top:80px;">
          <h2>Geschafft!</h2>
          <p>Das hast du super gemacht!</p>
          <img src="stimuli_AD/i_002.jpg" alt="Endbild" style="max-width:300px; margin-top:20px; border-radius:12px;">
      <div style="margin-top:22px;">
        <button class="next-btn" id="goodbye-next">
          <img src="stimuli_AD/next.png" alt="Weiter">
        </button>
      </div>
    </div>
      `,
      on_load: function(){
        if(general.goodbye_audio){
          playAudio(STIM + general.goodbye_audio);
        }
        const btn = document.getElementById("goodbye-next");
        if(btn){
          btn.onclick = () => {
            jsPsych.finishTrial();
          };
        }
      }
    });

    jsPsych.init({
      timeline: timeline,
      display_element: "jspsych-target",
      on_finish: () => {
        jsPsych.data.displayData();
      }
    });

  })();
</script>
</body>
</html>
