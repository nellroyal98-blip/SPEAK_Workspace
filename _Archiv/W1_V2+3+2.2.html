<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Vokabelübung jsPsych – W1_V2 (OS-Präzision)</title>
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #fcfcfc; }
    .img-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 44px 44px;
      justify-content: center;
      margin: 40px 0;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .img-grid img { width: 235px; border: 5px solid transparent; border-radius: 18px; transition: border 0.2s; cursor: pointer; }
    .img-grid img.selected { border-color: #1a73e8; background: #f0f4fa; }
    .img-grid img.green { border-color: #4caf50 !important; background: #e9fbe9; }
    .img-grid img.red { border-color: #f44336 !important; background: #ffeaea; }
    .img-grid img.yellow { border-color: #ffc107 !important; background: #fffbe4; }
    .speaker-btn { background: none; border: none; outline: none; cursor: pointer; }
    .speaker-btn img { height: 70px; transition: filter 0.1s; }
    .speaker-btn:active img { filter: brightness(1.3); }
    .star-anim { display: block; margin: 0 auto 18px auto; height: 90px; }
    .next-btn { background: none; border: none; cursor: pointer; }
    .next-btn img { height: 62px; vertical-align: middle; }
    .hide { display: none !important; }
    .final-big { display:block; margin:0 auto 18px auto; height:280px;}
  </style>
</head>
<body>
<div id="jspsych-target"></div>
<script>
// CSV-Lader
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      header: true,
      download: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

// Shuffle
function shuffleWithKey(arr) {
  let m = arr.length, t, i;
  let order = arr.map((x,i) => i);
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = arr[m]; arr[m] = arr[i]; arr[i] = t;
    t = order[m]; order[m] = order[i]; order[i] = t;
  }
  return {arr, order};
}

Promise.all([
  loadCSV('data/K2_W1_V2_general.csv'),
  loadCSV('data/K2_W1_V2_task.csv')
]).then(function([generalData, trialsDataRaw]) {
  let trialsData = trialsDataRaw.filter(row => row.audio && row.target);

  const info = generalData[0];
  const explanationImage = 'stimuli/' + info.explanation_image;
  const explanationAudio = 'stimuli/' + info.explanation_audio;
  const goodbyeAudio = 'stimuli/' + info.goodbye_audio;
  const week = info.week || "1";

  const timeline = [];

  // --- Instruktion
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/SPEAK_transparenter_HG.png" style="height:90px; margin-bottom:14px; display:block; margin-left:auto; margin-right:auto;">
      <h2>Willkommen zur Übung Woche ${week}</h2>
      <img src="${explanationImage}" style="max-width:420px"><br>
      <p>Bitte lies die Aufgabenstellung sorgfältig.<br>Wenn du bereit bist, klicke auf "Start".</p>
    `,
    choices: [''],
    button_html: `<button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`
  });

  // --- Erklärung (Speaker)
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/SPEAK_transparenter_HG.png" style="height:90px; margin-bottom:14px; display:block; margin-left:auto; margin-right:auto;">
      <img src="${explanationImage}" style="max-width:420px; display:block; margin:0 auto 20px auto;">
      <div style="text-align:center;">
        <button id="play-explanation-audio" class="speaker-btn">
          <img src="stimuli/speaker.png" alt="Play">
        </button>
        <audio id="explanation-audio" src="${explanationAudio}"></audio>
        <div style="font-size:1.1em; color:#8BC53F; font-weight:bold; margin-top:8px;">Zum Anhören hier klicken!</div>
      </div>
    `,
    choices: [""],
    button_html: `<button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
    on_load: function() {
      document.getElementById("play-explanation-audio").addEventListener("click", function() {
        var audio = document.getElementById("explanation-audio");
        audio.currentTime = 0;
        audio.play();
        this.querySelector('img').src = "stimuli/speaker_playing.png";
        audio.onended = () => { this.querySelector('img').src = "stimuli/speaker.png"; };
      });
    },
    prompt: `<div style="margin-top: 16px;">Drücke auf den Lautsprecher, um dir die Aufgabe anzuhören. Danach kannst du auf „Weiter“ klicken.</div>`
  });

  // --- Hauptübungsblock (V2)
  trialsData.forEach((trial, trialIndex) => {
    timeline.push({
      type: "html-button-response",
      stimulus: function() {
        let speakerHtml = `
          <button id="play-vocab-audio" class="speaker-btn" style="display:block; margin:0 auto 10px auto;">
            <img src="stimuli/speaker.png" alt="Play">
          </button>
          <audio id="vocab-audio" src="stimuli/${trial.audio}"></audio>
        `;
        let images = [
          {file: trial.target, correct: true},
          {file: trial.image_2, correct: false},
          {file: trial.image_3, correct: false},
          {file: trial.image_4, correct: false}
        ];
        // Shuffle:
        let {arr:shuffled, order} = shuffleWithKey(images);
        trial._images = shuffled;
        trial._correctIndex = shuffled.findIndex(img => img.correct);
        // 2x2 Grid!
        return speakerHtml + `<div class="img-grid">` + shuffled.map((img, i) =>
          `<img src="stimuli/${img.file}" data-idx="${i}" data-correct="${img.correct ? 1 : 0}" tabindex="0">`
        ).join('') + `</div>`;
      },
      choices: [],
      prompt: "",
      data: {trial_index: trialIndex},
      on_load: function() {
        let btn = document.getElementById("play-vocab-audio");
        let audio = document.getElementById("vocab-audio");
        btn.addEventListener("click", function() {
          audio.currentTime = 0; audio.play();
          btn.querySelector('img').src = "stimuli/speaker_playing.png";
          audio.onended = () => { btn.querySelector('img').src = "stimuli/speaker.png"; };
        });

        let selected = false;
        let errorCount = 0;
        let trial = trialsData[this.data.trial_index];
        let correctIdx = trial._correctIndex;
        let imgs = document.querySelectorAll('.img-grid img');

        imgs.forEach((img, idx) => {
          img.addEventListener('click', function handler() {
            if (selected) return; // Doppelklick verhindern
            selected = true;
            imgs.forEach(im => im.classList.remove('selected', 'green', 'red', 'yellow'));
            let isCorrect = img.getAttribute('data-correct') === "1";
            if (isCorrect) {
              img.classList.add('green');
              let star = new Audio("stimuli/stars_correct.mp3");
              star.play();
              setTimeout(() => jsPsych.finishTrial({
                correct: true,
                chosen_index: idx,
                correct_index: correctIdx,
                chosen_image: img.src,
                images: trial._images.map(x=>x.file)
              }), 1000); // minimal länger
            } else {
              img.classList.add('red');
              errorCount++;
              if (errorCount === 1) {
                let wrongSound = new Audio("stimuli/" + trial.followup_audio_first_false_answer);
                wrongSound.play();
                wrongSound.onended = function() {
                  imgs.forEach(im => im.classList.remove('red'));
                  selected = false;
                };
              } else {
  // Zweiter Fehler: Bild wieder rot, nach Feedback entfernen, dann gelb + Lösungssound
 img.classList.add('red');
  setTimeout(function() {
    imgs.forEach(im => im.classList.remove('red'));
    imgs[correctIdx].classList.add('yellow');
    let solSound = new Audio("stimuli/" + trial.followup_audio_second_false_answer);
    solSound.play();
    solSound.onended = function() {
      setTimeout(() => jsPsych.finishTrial({
        correct: false,
        chosen_index: idx,
        correct_index: correctIdx,
        chosen_image: img.src,
        images: trial._images.map(x=>x.file)
      }), 600);
    };
  }, 400); // 400 ms roter Rahmen
              }
            }
          });
        });
      }
    });
  });

  // --- Abschlussbildschirm Hauptübung
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_002.jpg" class="final-big">
      <h2>Geschafft!</h2>
      <p>Du hast alle Aufgaben abgeschlossen.</p>
      <button id="play-goodbye-audio" class="speaker-btn">
        <img src="stimuli/speaker.png" alt="Play">
      </button>
      <audio id="goodbye-audio" src="${goodbyeAudio}"></audio>
    `,
    choices: [""],
    button_html: `<button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
    on_load: function() {
      document.getElementById("play-goodbye-audio").addEventListener("click", function() {
        let audio = document.getElementById("goodbye-audio");
        audio.currentTime = 0; audio.play();
        this.querySelector('img').src = "stimuli/speaker_playing.png";
        audio.onended = () => { this.querySelector('img').src = "stimuli/speaker.png"; };
      });
    }
  });

  // =======================
  // Wiederholungsübung (V3)
  // =======================

  function startWiederholungsuebung(trialsData) {
    // --- INSTRUKTION ---
    timeline.push({
      type: "html-button-response",
      stimulus: `
        <img src="stimuli/i_265.jpg" style="height:120px; margin-bottom:22px; display:block; margin-left:auto; margin-right:auto;">
        <div style="margin-bottom: 18px;">
          <button id="play-v3-instr" class="speaker-btn" style="display:block; margin:0 auto 10px auto;">
            <img src="stimuli/speaker.png" alt="Play">
          </button>
          <audio id="v3-instr-audio" src="stimuli/ai_006.mp3"></audio>
        </div>
        <div style="font-size:1.1em; color:#8BC53F; font-weight:bold; margin-bottom:10px;">
          Hör dir die Aufgabe an, dann kannst du die Wörter wiederholen!
        </div>
      `,
      choices: [""],
      button_html: `<button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
      on_load: function() {
        document.getElementById("play-v3-instr").addEventListener("click", function() {
          let audio = document.getElementById("v3-instr-audio");
          audio.currentTime = 0; audio.play();
          this.querySelector('img').src = "stimuli/speaker_playing.png";
          audio.onended = () => { this.querySelector('img').src = "stimuli/speaker.png"; };
        });
      }
    });

    // --- HAUPTTRIALS (randomisiert) ---
    let trialsV3 = trialsData.filter(row => row.audio && row.target);
    let shuffledV3 = shuffleWithKey(trialsV3).arr;

    shuffledV3.forEach((trial, idx) => {
      timeline.push({
        type: "html-button-response",
        stimulus: function() {
          return `
            <div style="position:relative; height:420px;">
              <img src="stimuli/highlight_box_gray_large.png"
                style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:345px; z-index:1;">
              <img src="stimuli/${trial.target}" id="repeat-img" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:235px; z-index:2;">
              <img src="stimuli/highlight_box_orange_large.png" id="highlight-orange" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:345px; z-index:3;">
            </div>
            <button id="play-repeat-audio" class="speaker-btn" style="display:block; margin:0 auto 18px auto;">
              <img src="stimuli/speaker.png" alt="Play">
            </button>
            <audio id="repeat-audio" src="stimuli/${trial.audio}"></audio>
            <div id="repeat-next-btn" class="hide" style="text-align:center; margin-top:36px;">
              <button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>
            </div>
          `;
        },
        choices: [],
        prompt: "",
        on_load: function() {
          let btn = document.getElementById("play-repeat-audio");
          let audio = document.getElementById("repeat-audio");
          let nextBtnDiv = document.getElementById("repeat-next-btn");
          let highlightOrange = document.getElementById("highlight-orange");
          let nextBtn = nextBtnDiv.querySelector("button");
          let firstPlayDone = false;

          function playAudioAndWait() {
            nextBtnDiv.classList.add('hide');
            highlightOrange.classList.remove('hide');
            audio.currentTime = 0; audio.play();
            btn.querySelector('img').src = "stimuli/speaker_playing.png";
            audio.onended = () => {
              btn.querySelector('img').src = "stimuli/speaker.png";
              highlightOrange.classList.add('hide');
              if (!firstPlayDone) {
                firstPlayDone = true;
                setTimeout(() => nextBtnDiv.classList.remove('hide'), 500);
              } else {
                nextBtnDiv.classList.remove('hide');
              }
            };
          }

          // Beim Start sofort einmal automatisch abspielen:
          playAudioAndWait();

          btn.addEventListener("click", playAudioAndWait);

          nextBtn.addEventListener("click", function() {
            // Feedback (Sterne + Sound) mit Timer, bevor das nächste Wort gezeigt wird!
            let feedbackDiv = document.createElement('div');
            feedbackDiv.style = "position:fixed; left:0;top:0;width:100vw;height:100vh;z-index:1000;background:rgba(255,255,255,0.94);display:flex;flex-direction:column;align-items:center;justify-content:center;";
            feedbackDiv.innerHTML = `
              <img src="stimuli/stars.png" style="width:190px;">
              <audio id="star-feedback" src="stimuli/stars_correct.mp3" autoplay></audio>
            `;
            document.body.appendChild(feedbackDiv);
            let audioElem = feedbackDiv.querySelector('#star-feedback');
            let finished = false;
            function finishTrial() {
              if (!finished) {
                document.body.contains(feedbackDiv) && document.body.removeChild(feedbackDiv);
                jsPsych.finishTrial();
                finished = true;
              }
            }
            audioElem.onended = function() {
              setTimeout(finishTrial, 650);
            };
            setTimeout(finishTrial, 1900);
          });
        }
      });
    });

    // --- Abschluss Wiederholung
    timeline.push({
      type: "html-button-response",
      stimulus: `
        <img src="stimuli/i_002.jpg" class="final-big">
        <h2>Super!</h2>
        <p>Du hast die Wiederholungsübung abgeschlossen.</p>
        <button id="play-v3-goodbye" class="speaker-btn">
          <img src="stimuli/speaker.png" alt="Play">
        </button>
        <audio id="v3-goodbye-audio" src="stimuli/ai_021.mp3"></audio>
      `,
      choices: [""],
      button_html: `<button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
      on_load: function() {
        document.getElementById("play-v3-goodbye").addEventListener("click", function() {
          let audio = document.getElementById("v3-goodbye-audio");
          audio.currentTime = 0; audio.play();
          this.querySelector('img').src = "stimuli/speaker_playing.png";
          audio.onended = () => { this.querySelector('img').src = "stimuli/speaker.png"; };
        });
      }
    });
  }

  // ====== Wiederholungsübung starten (direkt im Anschluss an Hauptteil)
  startWiederholungsuebung(trialsData);

  // ====== jsPsych INIT ======
  jsPsych.init({
    timeline: timeline,
    display_element: 'jspsych-target',
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
});
</script>
</body>
</html>
