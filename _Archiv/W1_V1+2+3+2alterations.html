<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>SPEAK Story + Vokabelübung</title>
  <script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
  <link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">
  <script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #fcfcfc; }
    .story-img { display:block; margin:0 auto; max-width: 380px; max-height: 330px; border-radius:18px; }
    .clickable { cursor: pointer; box-shadow:0 0 0 3px #ffd940; }
    .clickable:active { filter: brightness(1.06);}
    .disabled { opacity:0.7; pointer-events:none; }
    .next-btn { background: none; border: none; cursor: pointer; }
    .next-btn img { height: 62px; vertical-align: middle; }
    .hide { display: none !important; }
    .adventure-instr {text-align:center; color:#348f50; font-size:1.2em; margin-top:18px;}
    .img-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 44px 44px;
      justify-content: center;
      margin: 40px 0;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .img-grid img { width: 235px; border: 5px solid transparent; border-radius: 18px; transition: border 0.2s; cursor: pointer; }
    .img-grid img.selected { border-color: #1a73e8; background: #f0f4fa; }
    .img-grid img.green { border-color: #4caf50 !important; background: #e9fbe9; }
    .img-grid img.red { border-color: #f44336 !important; background: #ffeaea; }
    .img-grid img.yellow { border-color: #ffc107 !important; background: #fffbe4; }
    .star-anim { display: block; margin: 0 auto 18px auto; height: 90px; }
    .big-instr { display:block; margin:0 auto 18px auto; height:370px;}
    .final-big { display:block; margin:0 auto 18px auto; height:320px;}
    .big-end { display:block; margin:0 auto 18px auto; height:330px;}
    .arrow { position:absolute; z-index:9; }
    .arrow-bottom { left:50%; bottom:32px; transform:translateX(-50%) rotate(90deg); height:85px; }
    .arrow-top { left:50%; top:36px; transform:translateX(-50%) rotate(-90deg); height:85px; }
  </style>
</head>
<body>
<div id="jspsych-target"></div>
<script>
// ==== Hilfsfunktionen ====
// CSV-Lader
function loadCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      header: true,
  download: true,
  skipEmptyLines: true,
  dynamicTyping: false,
  trimHeaders: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}
function shuffleWithKey(arr) {
  let m = arr.length, t, i;
  let order = arr.map((x,i) => i);
  while (m) {
    i = Math.floor(Math.random() * m--);
    t = arr[m]; arr[m] = arr[i]; arr[i] = t;
    t = order[m]; order[m] = order[i]; order[i] = t;
  }
  return {arr, order};
}

// ======== Timeline Aufbau START ========
let timeline = [];

// ==== GANZ GANZ VORNE: Echter Startbildschirm ==== 
timeline.push({
  type: "html-button-response",
  stimulus: `
    <img src="stimuli/SPEAK_transparenter_HG.png" style="height:110px; margin:0 auto 36px auto; display:block;">
    <h1 style="text-align:center; color:#1a73e8; font-size:2.2em; margin-bottom:16px;">Willkommen</h1>
    <div style="text-align:center; font-size:1.25em; color:#348f50; margin-bottom:36px;">
      Klicke auf den grünen Pfeil, um zu starten.
    </div>
  `,
  choices: [""],
  button_html: `<button class="next-btn" id="welcome-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
  on_load: function() {
    document.getElementById("welcome-next-btn").onclick = function() { jsPsych.finishTrial(); };
  }
});


// ========== VOCABULARY ÜBUNG ==========
// ...Kopiere diesen Block komplett in dein Skript...
function makeV2Trial(trial, trialIndex) {
  return {
    type: "html-button-response",
    stimulus: function() {
      let speakerHtml = `
        <audio id="vocab-audio" src="stimuli/${trial.audio}"></audio>
        <button id="play-vocab-audio" class="speaker-btn" style="display:block; margin:0 auto 10px auto;">
          <img src="stimuli/speaker.png" alt="Play">
        </button>
      `;
      let images = [
        {file: trial.target, correct: true},
        {file: trial.image_2, correct: false},
        {file: trial.image_3, correct: false},
        {file: trial.image_4, correct: false}
      ];
      let {arr:shuffled, order} = shuffleWithKey(images);
      trial._images = shuffled;
      trial._correctIndex = shuffled.findIndex(img => img.correct);
      return speakerHtml + `<div class="img-grid">` + shuffled.map((img, i) =>
        `<img src="stimuli/${img.file}" data-idx="${i}" data-correct="${img.correct ? 1 : 0}" tabindex="0" style="pointer-events:none; opacity:0.7;">`
      ).join('') + `</div>`;
    },
    choices: [],
    prompt: "",
    data: {trial_index: trialIndex},
    on_load: function() {
      let btn = document.getElementById("play-vocab-audio");
      let audio = document.getElementById("vocab-audio");
      let imgs = document.querySelectorAll('.img-grid img');
      btn.querySelector('img').src = "stimuli/speaker_playing.png";
      document.body.style.cursor = "none";
      audio.play();
      function unlockImgs() {
        imgs.forEach(im => { im.style.pointerEvents = "auto"; im.style.opacity = "1"; });
        btn.querySelector('img').src = "stimuli/speaker.png";
        document.body.style.cursor = "";
      }
      audio.onended = unlockImgs;
      btn.addEventListener("click", function() {
        btn.querySelector('img').src = "stimuli/speaker_playing.png";
        imgs.forEach(im => { im.style.pointerEvents = "none"; im.style.opacity = "0.7"; });
        document.body.style.cursor = "none";
        audio.currentTime = 0; audio.play();
      });
      audio.onplay = function() { btn.querySelector('img').src = "stimuli/speaker_playing.png"; };
      let selected = false;
      let errorCount = 0;
      let correctIdx = trial._correctIndex;
      imgs.forEach((img, idx) => {
        img.addEventListener('click', function handler() {
          if (img.style.pointerEvents === "none") return;
          if (selected) return;
          selected = true;
          imgs.forEach(im => im.classList.remove('selected', 'green', 'red', 'yellow'));
          let isCorrect = img.getAttribute('data-correct') === "1";
          if (isCorrect) {
            img.classList.add('green');
            let star = new Audio("stimuli/stars_correct.mp3");
            star.play();
            setTimeout(() => jsPsych.finishTrial({
              correct: true,
              chosen_index: idx,
              correct_index: correctIdx,
              chosen_image: img.src,
              images: trial._images.map(x=>x.file)
            }), 1000);
          } else {
            img.classList.add('red');
            errorCount++;
            if (errorCount === 1) {
              let wrongSound = new Audio("stimuli/" + trial.followup_audio_first_false_answer);
              wrongSound.play();
              wrongSound.onended = function() {
                imgs.forEach(im => im.classList.remove('red'));
                selected = false;
              };
            } else {
              img.classList.add('red');
              setTimeout(function() {
                imgs.forEach(im => im.classList.remove('red'));
                imgs[correctIdx].classList.add('yellow');
                let solSound = new Audio("stimuli/" + trial.followup_audio_second_false_answer);
                solSound.play();
                solSound.onended = function() {
                  setTimeout(() => jsPsych.finishTrial({
                    correct: false,
                    chosen_index: idx,
                    correct_index: correctIdx,
                    chosen_image: img.src,
                    images: trial._images.map(x=>x.file)
                  }), 600);
                };
              }, 400);
            }
          }
        });
      });
    }
  };
}

function startWiederholungsuebung(trialsData, timeline) {
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_265.jpg" class="big-instr">
      <audio id="v3-instr-audio" src="stimuli/ai_006.mp3"></audio>
    `,
    choices: [""],
    button_html: `<button class="next-btn hide" id="v3-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
    on_load: function() {
      const audio = document.getElementById("v3-instr-audio");
      const nextBtn = document.getElementById("v3-next-btn");
      document.body.style.cursor = "none";
      audio.play();
      audio.onended = () => {
        nextBtn.classList.remove("hide");
        document.body.style.cursor = "";
      };
      nextBtn.onclick = function() { jsPsych.finishTrial(); };
    }
  });
  let trialsV3 = shuffleWithKey(trialsData.filter(row => row.audio && row.target)).arr;
  trialsV3.forEach((trial, idx) => {
    timeline.push({
      type: "html-button-response",
      stimulus: function() {
        return `
          <div style="position:relative; height:420px;">
            <img src="stimuli/highlight_box_gray_large.png"
              style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:345px; z-index:1;">
            <img src="stimuli/${trial.target}" id="repeat-img" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:235px; z-index:2;">
            <img src="stimuli/highlight_box_orange_large.png" id="highlight-orange" style="position:absolute; left:50%; top:35%; transform:translate(-50%,-50%); width:345px; z-index:3;">
          </div>
          <audio id="repeat-audio" src="stimuli/${trial.audio}"></audio>
          <div id="repeat-next-btn" class="hide" style="text-align:center; margin-top:36px;">
            <button class="next-btn"><img src="stimuli/next.png" alt="Weiter"></button>
          </div>
        `;
      },
      choices: [],
      prompt: "",
      on_load: function() {
        let audio = document.getElementById("repeat-audio");
        let nextBtnDiv = document.getElementById("repeat-next-btn");
        let highlightOrange = document.getElementById("highlight-orange");
        let nextBtn = nextBtnDiv.querySelector("button");
        let firstPlayDone = false;
        document.body.style.cursor = "none";
        audio.play();
        audio.onplay = function() {};
        function finishAudio() {
          highlightOrange.classList.add('hide');
          if (!firstPlayDone) {
            firstPlayDone = true;
            setTimeout(() => nextBtnDiv.classList.remove('hide'), 500);
          } else {
            nextBtnDiv.classList.remove('hide');
          }
          document.body.style.cursor = "";
        }
        highlightOrange.classList.remove('hide');
        nextBtnDiv.classList.add('hide');
        audio.onended = finishAudio;
        nextBtn.onclick = function() {
          let feedbackDiv = document.createElement('div');
          feedbackDiv.style = "position:fixed; left:0;top:0;width:100vw;height:100vh;z-index:1000;background:rgba(255,255,255,0.94);display:flex;flex-direction:column;align-items:center;justify-content:center;";
          feedbackDiv.innerHTML = `
            <img src="stimuli/stars.png" style="width:190px;">
            <audio id="star-feedback" src="stimuli/stars_correct.mp3" autoplay></audio>
          `;
          document.body.appendChild(feedbackDiv);
          let audioElem = feedbackDiv.querySelector('#star-feedback');
          let finished = false;
          function finishTrial() {
            if (!finished) {
              document.body.contains(feedbackDiv) && document.body.removeChild(feedbackDiv);
              jsPsych.finishTrial();
              finished = true;
            }
          }
          audioElem.onended = function() { setTimeout(finishTrial, 650); };
          setTimeout(finishTrial, 1900);
        };
      }
    });
  });
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_002.jpg" class="final-big">
      <h2>Super!</h2>
      <p>Du hast die Wiederholungsübung abgeschlossen.</p>
      <button id="play-v3-goodbye" class="speaker-btn hide">
        <img src="stimuli/speaker.png" alt="Play">
      </button>
      <audio id="v3-goodbye-audio" src="stimuli/ai_021.mp3"></audio>
    `,
    choices: [""],
    button_html: `<button class="next-btn" id="v3-goodbye-next"><img src="stimuli/next.png" alt="Weiter"></button>`,
    on_load: function() {
      const audio = document.getElementById("v3-goodbye-audio");
      audio.play();
      document.getElementById("v3-goodbye-next").onclick = function() {
        jsPsych.finishTrial();
      };
    }
  });
}



// ==== STORY/ABENTEUER (V1) aus CSV ====
// Lade die Mapping-CSV (General+Task) und starte dann das Experiment:
Promise.all([
  loadCSV('data/K2_W1_V1_general.csv'),  // Allgemeine Infos (z.B. Audios für Intro/Outro)
  loadCSV('data/K2_W1_V1_task.csv'),     // Reihenfolge + Bild-/Audio-Zuordnung
  loadCSV('data/K2_W1_V2_general.csv'),
  loadCSV('data/K2_W1_V2_task.csv')
]).then(function([v1_general, v1_task, v2_general, v2_task]) {
  // V1 General wird für Intro/Outro genutzt, falls du das ausbauen willst!
  // V1_TASK enthält alle Schritte (story_audio, show_on_screen, target, target_audio, definition_audio, etc.)

  // === V1-Story Introbild (wie im OS-Original, wenn es in v1_general steht, sonst einfach weglassen) ===
// NACHDEM du v1_task geladen hast (als Array aus PapaParse!)
const storyStimuli = [
  // Hier ALLES IN DER GEWÜNSCHTEN REIHENFOLGE, Zeile für Zeile
  { story_audio: "at_179.mp3", show_on_screen: "i_107.jpg", target: "i_004.jpg", target_audio: "at_3974.mp3", definition_audio: "at_001.mp3" },
  { story_audio: "at_180.mp3", show_on_screen: "i_107.jpg", target: "i_005.jpg", target_audio: "at_3975.mp3", definition_audio: "at_002.mp3" },
  { story_audio: "at_181.mp3", show_on_screen: "i_108.jpg", target: "i_006.jpg", target_audio: "at_3976.mp3", definition_audio: "at_003.mp3" },
  { story_audio: "at_182.mp3", show_on_screen: "i_109.jpg" },
  { story_audio: "at_183.mp3", show_on_screen: "i_110.jpg" },
  { story_audio: "at_184.mp3", show_on_screen: "i_111.jpg", target: "i_007.jpg", target_audio: "at_009.mp3", definition_audio: "at_004.mp3" },
  { story_audio: "at_185.mp3", show_on_screen: "i_111.jpg" },
  { story_audio: "at_186.mp3", show_on_screen: "i_112.jpg", target: "i_008.jpg", target_audio: "at_010.mp3", definition_audio: "at_005.mp3" },
  { story_audio: "at_187.mp3", show_on_screen: "i_112.jpg" },
  { story_audio: "at_188.mp3", show_on_screen: "i_110.jpg" },
  { story_audio: "at_189.mp3", show_on_screen: "i_109.jpg" }
];

// Die eigentliche Timeline
storyStimuli.forEach(stim => {
  // Schritt 1: Show_on_screen + story_audio
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/${stim.show_on_screen}" class="story-img">
      <audio id="story-audio" src="stimuli/${stim.story_audio}"></audio>
      <div class="adventure-instr">Höre dir die Geschichte an.</div>
    `,
    choices: [""],
    button_html: `<button class="next-btn hide" id="scene-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
    on_load: function() {
      const audio = document.getElementById("story-audio");
      const nextBtn = document.getElementById("scene-next-btn");
      document.body.style.cursor = "none";
      audio.play();
      audio.onended = function() {
        document.body.style.cursor = "";
        nextBtn.classList.remove("hide");
        nextBtn.onclick = function() { jsPsych.finishTrial(); };
      };
    }
  });

  // Schritt 2: Wenn Target/Definition vorhanden, erst Target-Audio, dann nach Klick Definition
  if (stim.target && stim.target_audio && stim.definition_audio) {
    timeline.push({
      type: "html-button-response",
      stimulus: `
        <img src="stimuli/${stim.target}" class="story-img clickable" id="target-img" style="box-shadow:0 0 0 6px #ffc940;">
        <div class="adventure-instr">Höre dir das neue Wort an. Klicke dann auf das Bild für die Erklärung!</div>
        <audio id="target-audio" src="stimuli/${stim.target_audio}"></audio>
        <audio id="definition-audio" src="stimuli/${stim.definition_audio}"></audio>
      `,
      choices: [""],
      button_html: `<button class="next-btn hide" id="def-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
      on_load: function() {
        const img = document.getElementById("target-img");
        const targetAudio = document.getElementById("target-audio");
        const defAudio = document.getElementById("definition-audio");
        const nextBtn = document.getElementById("def-next-btn");
        let defPlayed = false;

        img.style.pointerEvents = "none";
        document.body.style.cursor = "none";
        targetAudio.play();

        targetAudio.onended = function() {
          document.body.style.cursor = "";
          img.style.pointerEvents = "auto";
          img.classList.add("clickable");
          img.onclick = function() {
            if (defPlayed) return;
            defPlayed = true;
            img.classList.remove("clickable");
            img.style.boxShadow = "0 0 0 8px #50c878";
            defAudio.play();
            defAudio.onended = function() {
              nextBtn.classList.remove("hide");
              nextBtn.onclick = function() { jsPsych.finishTrial(); };
            };
          };
        };
      }
    });
  }
});


  // ======= Dann: "Beispiel"-Willkommensbildschirm (wie gehabt) =======
  const v2_info = v2_general[0];
  const week = v2_info.week || "1";
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/SPEAK_transparenter_HG.png" style="height:100px; margin-bottom:18px; display:block; margin-left:auto; margin-right:auto;">
      <h2 style="text-align:center;">Willkommen zur Übung Woche ${week}</h2>
      <div style="
        display: flex; justify-content: center; align-items: center; margin: 24px 0 18px 0;">
        <div style="
          border: 5px solid #4caf50;
          box-shadow: 0 4px 18px 0 rgba(90,180,120,0.16), 0 1.5px 8px 0 rgba(34,70,20,0.13);
          border-radius: 24px;
          padding: 14px 18px 12px 18px;
          background: #f5fcf5;
          ">
          <img src="stimuli/Week1_V2.png" style="display:block; height:230px; border-radius:16px;">
          <div style="text-align:center; font-size:0.95em; color:#348f50; margin-top:6px;">
            Beispiel
          </div>
        </div>
      </div>
      <audio id="instr-audio" src="stimuli/ai_004.mp3"></audio>
      <div style="font-size:1.1em; color:#8BC53F; font-weight:bold; margin-top:8px; text-align:center;">
                Bitte höre dir die Aufgabenstellung sorgfältig an. Wenn du bereit bist, klicke auf den grünen Pfeil.
      </div>
    `,
    choices: [""],
    button_html: `<button class="next-btn hide" id="instr-next-btn"><img src="stimuli/next.png" alt="Weiter"></button>`,
    on_load: function() {
      const audio = document.getElementById("instr-audio");
      const nextBtn = document.getElementById("instr-next-btn");
      document.body.style.cursor = "none";
      audio.play();
      audio.onended = () => {
        nextBtn.classList.remove("hide");
        document.body.style.cursor = "";
      };
      nextBtn.onclick = function() { jsPsych.finishTrial(); };
    }
  });

  // ==== Ab hier alles wie gehabt: Vokabelübung (V2, V3, V2) ====
  // ... Dein kompletter JS-Code für die Vokabelübung ab hier (aus dem alten Skript) ...
  // Für Übersichtlichkeit kannst du den Block direkt von deinem alten Skript übernehmen!
  // (Hier zur Demo nur als Funktion vermerkt:)
  window.trialsData = v2_task.filter(row => row.audio && row.target);
  window.trialsData.forEach((trial, trialIndex) => {
    timeline.push(makeV2Trial(trial, trialIndex));
  });
  startWiederholungsuebung(window.trialsData, timeline);
  window.trialsData.forEach((trial, trialIndex) => {
    timeline.push(makeV2Trial(trial, trialIndex));
  });
  // Abschlussbildschirm
  const goodbyeAudio = 'stimuli/' + v2_info.goodbye_audio;
  timeline.push({
    type: "html-button-response",
    stimulus: `
      <img src="stimuli/i_002.jpg" class="final-big">
      <h2>Geschafft!</h2>
      <p>Du hast alle Aufgaben abgeschlossen.</p>
      <button id="play-goodbye-audio" class="speaker-btn">
        <img src="stimuli/speaker.png" alt="Play">
      </button>
      <audio id="goodbye-audio" src="${goodbyeAudio}"></audio>
    `,
    choices: [""],
    button_html: `<button class="next-btn"><img src="stimuli/next_small.png" alt="Weiter"></button>`,
    on_load: function() {
      document.getElementById("play-goodbye-audio").addEventListener("click", function() {
        let audio = document.getElementById("goodbye-audio");
        audio.currentTime = 0; audio.play();
        this.querySelector('img').src = "stimuli/speaker_playing.png";
        audio.onended = () => { this.querySelector('img').src = "stimuli/speaker.png"; };
      });
    }
  });
  jsPsych.init({
    timeline: timeline,
    display_element: 'jspsych-target',
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
});
</script>
</body>
</html>
