<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>SPEAK W6 A3</title>

<script src="https://unpkg.com/jspsych@6.3.1/jspsych.js"></script>
<script src="https://unpkg.com/jspsych@6.3.1/plugins/jspsych-html-button-response.js"></script>
<link href="https://unpkg.com/jspsych@6.3.1/css/jspsych.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=ABeeZee&display=swap" rel="stylesheet">

<style>
body{ background:#fff; margin:0; padding:0; }
.center{ text-align:center; }

.jspsych-display-element,
.jspsych-display-element *{
  font-family:"ABeeZee", sans-serif;
}

.topBar{
  height:150px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.taskLabel{
  position:absolute;
  right:20px;
  top:18px;
  font-size:20px;
}

.topSpeaker img{
  height:120px;
  cursor:pointer;
}

.midBox{
  width:480px;
  height:360px;
  margin:28px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.midBox img.stim{
  max-width:420px;
  max-height:300px;
  cursor:pointer;
  z-index:1;
}

#midHL{
  position:absolute;
  width:460px;
  height:340px;
  display:none;
  pointer-events:none;
  z-index:2;
}

.bottomRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:24px;
}

.optBox img{
  width:190px;
  cursor:pointer;
}

.yellow{ outline:14px solid #ffd400; border-radius:22px; }
.red{ outline:14px solid #e10000; border-radius:22px; }
.green{ outline:14px solid #1aa64a; border-radius:22px; }

.centerBar img{
  width:220px;
  cursor:pointer;
}

.centerBar.disabled img{
  pointer-events:none;
}
</style>
</head>

<body>
<div id="jspsych-target"></div>

<script>
const BASE="/speakjspsych/";
const DATA=BASE+"data/";
const STIM=BASE+"stimuli_F_1/";

/* ---------- CSV LOADER (FIX!) ---------- */
function loadCSV(url){
  return new Promise(resolve=>{
    Papa.parse(url,{
      header:true,
      download:true,
      complete:r=>{
        const rows=(r.data||[]).filter(x =>
          x && Object.values(x).some(v=>String(v||"").trim()!=="")
        );
        resolve(rows);
      }
    });
  });
}

(async function(){

/* ---------- LOAD DATA ---------- */
const general = (await loadCSV(DATA+"K2_W6_A3_general.csv"))[0];
const trials  = (await loadCSV(DATA+"K2_W6_A3_task.csv"))
  .filter(r=>r.image1);

/* ---------- START SCREEN ---------- */
const start={
  type:"html-button-response",
  choices:[],
  stimulus:`
    <div class="center" style="margin-top:40px;">
      <h1>Willkommen – SPEAK Woche ${general.week}</h1>
      <p>Hör dir die Erklärung an.</p>

      <img src="${STIM}Week6_A3.png"
           style="width:560px;border:6px solid #999;border-radius:18px;">

      <br><br>

      <img id="sSp" src="${STIM}speaker.png"
           style="height:120px;cursor:pointer">

      <br><br>

      <img id="sNext" src="${STIM}next_empty.png" style="height:120px;cursor:pointer">


      <audio id="sAu" src="${STIM}${general.explanation_audio}"></audio>
    </div>
  `,
  on_load(){
    const sp=sSp, nx=sNext, au=sAu;

    function play(){
      sp.src=STIM+"speaker_playing.png";
      au.currentTime=0;
      au.play();
    }

    sp.onclick=play;

    au.onended=()=>{
      sp.src=STIM+"speaker.png";
      nx.src=STIM+"next.png";
    };

    nx.onclick=()=>jsPsych.finishTrial();
  }
};

/* ---------- TASK ---------- */
function makeTrial(t){
  return{
    type:"html-button-response",
    choices:[],
    stimulus:`
      <div class="wrap">
        <div class="topBar">
          <div class="topSpeaker">
            <img id="qSpImg" src="${STIM}speaker.png">
          </div>
          <div class="taskLabel">A3</div>
        </div>

        <div class="midBox">
          <img id="stim" class="stim" src="${STIM}${t.image1}">
          <img id="midHL" src="${STIM}highlight_box_orange_large.png">
        </div>

        <div class="bottomRow">
          <div class="optBox"><img id="L" src="${STIM}speaker_response_option.png"></div>

          <div class="centerBar disabled">
            <img id="C" src="${STIM}next_small_empty.png">
          </div>

          <div class="optBox"><img id="R" src="${STIM}speaker_response_option.png"></div>
        </div>

        <audio id="qAu" src="${STIM}${t.question}"></audio>
      </div>
    `,
    on_load(){
  const qSpImg = document.getElementById("qSpImg");
  const stim   = document.getElementById("stim");
  const midHL  = document.getElementById("midHL");
  const qAu    = document.getElementById("qAu");
  const L      = document.getElementById("L");
  const R      = document.getElementById("R");
  const C      = document.getElementById("C");

  let attempt = 1;
  let selected = null;
  let locked = false;
  let heard = { L:false, R:false };

  const map = {
    L:{ audio:new Audio(STIM + t.audio_target), correct:true },
    R:{ audio:new Audio(STIM + t.audio_distractor), correct:false }
  };

  function playQuestion(){
    if(locked) return;
    qSpImg.src = STIM + "speaker_playing.png";
    midHL.style.display = "block";
    qAu.currentTime = 0;
    qAu.play();
    qAu.onended = ()=>{
      qSpImg.src = STIM + "speaker.png";
      midHL.style.display = "none";
    };
  }

  function pick(side){
    if(locked) return;
    selected = side;
    heard[side] = true;

    L.classList.remove("yellow","red","green");
    R.classList.remove("yellow","red","green");

    document.getElementById(side).classList.add("yellow");
    map[side].audio.currentTime = 0;
    map[side].audio.play();

    if(heard.L && heard.R){
      C.src = STIM + "next_small.png";
      C.parentElement.classList.remove("disabled");
    }
  }

  function correct(){
    locked = true;
    document.getElementById(selected).classList.add("green");
    C.src = STIM + "stars.png";
    const a = new Audio(STIM + t.fb_correct);
    a.play();
    a.onended = ()=>jsPsych.finishTrial();
  }
function shuffleOptions(){
  // Shuffle-Grafik anzeigen
  C.src = STIM + "reshuffle.png";
  C.parentElement.classList.add("disabled");

  const s = new Audio(STIM + "shuffle.wav");
  s.play().catch(()=>{});

  // Audio-Zuordnung tauschen
  [map.L, map.R] = [map.R, map.L];

  s.onended = ()=>{
    C.src = STIM + "next_small_empty.png";
  };
}



  function wrong(){
    locked = true;
    document.getElementById(selected).classList.add("red");
    const fb = new Audio(
      STIM + (attempt===1 ? t.fb_incorrect_first_try : t.fb_incorrect_second_try)
    );
    fb.play();
    fb.onended = ()=>{
      if(attempt === 1){
  attempt = 2;
  L.classList.remove("yellow","red","green");
  R.classList.remove("yellow","red","green");
  selected = null;
  heard = {L:false, R:false};

  shuffleOptions();   // <<< NUR DAS IST NEU

  locked = false;
  playQuestion();
}
 else {
        jsPsych.finishTrial();
      }
    };
  }

  qSpImg.onclick = playQuestion;
  stim.onclick   = playQuestion;
  L.onclick      = ()=>pick("L");
  R.onclick      = ()=>pick("R");
  C.onclick      = ()=> map[selected]?.correct ? correct() : wrong();

  playQuestion();
}

  };
}

/* ---------- END ---------- */
const endScreen={
  type:"html-button-response",
  choices:[],
  stimulus:`
    <div class="center" style="margin-top:80px;">
      <h2>Geschafft!</h2>
      <p>Das hast du super gemacht!</p>
      <img src="${STIM}i_002.jpg"
           style="max-width:300px;margin-top:20px;border-radius:12px;">
      <div style="margin-top:24px;">
        <img id="endNext" src="${STIM}next.png"
             style="width:200px;cursor:pointer">
      </div>
      <audio id="byeAu" src="${STIM}${general.goodbye_audio || ""}"></audio>
    </div>
  `,
  on_load(){
    const au=byeAu;
    if(au && au.src) au.play().catch(()=>{});
    endNext.onclick=()=>jsPsych.finishTrial();
  }
};

/* ---------- TIMELINE ---------- */
const timeline=[start];
trials.forEach(t=>timeline.push(makeTrial(t)));
timeline.push(endScreen);

jsPsych.init({
  timeline,
  display_element:"jspsych-target"
});

})();
</script>
</body>
</html>
